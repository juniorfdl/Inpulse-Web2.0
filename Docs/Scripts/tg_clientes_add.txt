ALTER TABLE `crm_sgr`.`clientes` 
CHANGE COLUMN `DATACAD` `DATACAD` DATETIME NULL DEFAULT now ;
DROP TRIGGER IF EXISTS `crm_sgr`.`tg_clientes_add`;

DELIMITER $$
USE `crm_sgr`$$
CREATE DEFINER=`root`@`localhost` TRIGGER `tg_clientes_add` BEFORE INSERT ON `clientes` FOR EACH ROW BEGIN
  
  SET NEW.DATACAD = now(); 
  
  IF LENGTH(CONCAT(NEW.AREA1,NEW.FONE1)) >= 10 THEN
    INSERT IGNORE INTO fones_campanha_cli (CLIENTE,FONE,TIPO_CONTATO, TIPO_FONE)
	 VALUES(NEW.CODIGO,CONCAT(NEW.AREA1,NEW.FONE1),"Cliente", NEW.DESC_FONE1);
  END IF; 
  
  IF LENGTH(CONCAT(NEW.AREA2,NEW.FONE2)) >= 10 THEN
    INSERT IGNORE INTO fones_campanha_cli (CLIENTE,FONE,TIPO_CONTATO, TIPO_FONE)
	 VALUES(NEW.CODIGO,CONCAT(NEW.AREA2,NEW.FONE2),"Cliente", NEW.DESC_FONE2);
  END IF; 
  
  IF LENGTH(CONCAT(NEW.AREA3,NEW.FONE3)) >= 10 THEN
    INSERT IGNORE INTO fones_campanha_cli (CLIENTE,FONE,TIPO_CONTATO, TIPO_FONE)
	 VALUES(NEW.CODIGO,CONCAT(NEW.AREA3,NEW.FONE3),"Cliente", NEW.DESC_FONE3);
  END IF;

  IF TRIM(NEW.COD_ERP) = "" THEN 
    SET NEW.COD_ERP = NULL; 
  END IF;

  SET @contador = 0; 
  
  SELECT MIN(CODIGO) FROM (SELECT (CODIGO) FROM
     fones_campanha_cli WHERE CLIENTE = NEW.CODIGO order by CODIGO desc limit 3)	A
  INTO @contador;
     
  if (@contador > 0) then
    delete from fones_campanha_cli WHERE CLIENTE = NEW.CODIGO and CODIGO < @contador;
  END IF;

END$$
DELIMITER ;
