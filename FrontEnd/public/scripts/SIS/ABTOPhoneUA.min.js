var url;var ABTOPhoneUACounter=1;var twoByteHigh=65535;var useStun=false;var useAudio=true;var useVideo=true;function ABTOPhoneUA(){this.sipUserAgentName="ABTOPhone";this.iceServers=[{url:"stun:stun.l.google.com:19302"},{url:"stun:stun1.l.google.com:19302"},{url:"stun:stun2.l.google.com:19302"},{url:"stun:stun3.l.google.com:19302"},{url:"stun:stun4.l.google.com:19302"}];this.remoteVideo=null;this.sipDomain=null;this.WSPort=null;this.secure=false;this.sipDisplayName=null;this.sipUserName=null;this.sipLogin=null;this.sipPassword=null;this.recoverySession=null;this.linkedId=null;this.callInfo=null;this.isConference=false;this.isUpgraded=false;this.conferenceId=null;this.conferenceMixerId=null;this.participantId=null;this.participantToken=null;this.resourceList=null;this.peerConnection=null;this.token=null;this.inited=false;this.remoteUser=null;this.reconnectCounter=0;this.reconnectTimer=null;this.counter=ABTOPhoneUACounter++;this.maxVideoBandwidth=0;this.registerAfterInit=false;this.paused=false;this.unInitAfterUnRegister=false;console.debug("ABTOPhoneUA("+this.counter+"):ABTOPhoneUA()")}ABTOPhoneUA.prototype=new SipListener();ABTOPhoneUA.prototype.constructor=ABTOPhoneUA;ABTOPhoneUA.prototype.version=function(){return"27.08.2018"};ABTOPhoneUA.prototype.UNREGISTERED_STATE="UNREGISTERED_STATE";ABTOPhoneUA.prototype.REGISTERING_STATE="REGISTERING_STATE";ABTOPhoneUA.prototype.REGISTER_REFRESHING_STATE="REGISTER_REFRESHING_STATE";ABTOPhoneUA.prototype.REGISTERING_401_STATE="REGISTERING_401_STATE";ABTOPhoneUA.prototype.REGISTERED_STATE="REGISTERED_STATE";ABTOPhoneUA.prototype.UNREGISTERING_401_STATE="UNREGISTERING_401_STATE";ABTOPhoneUA.prototype.UNREGISTERING_STATE="UNREGISTERING_STATE";ABTOPhoneUA.prototype.INVITING_INITIAL_STATE="INVITING_INITIAL_STATE";ABTOPhoneUA.prototype.INVITING_STATE="INVITING_STATE";ABTOPhoneUA.prototype.INVITING_407_STATE="INVITING_407_STATE";ABTOPhoneUA.prototype.INVITING_ACCEPTED_STATE="INVITING_ACCEPTED_STATE";ABTOPhoneUA.prototype.INVITING_LOCAL_HANGINGUP_STATE="INVITING_LOCAL_HANGINGUP_STATE";ABTOPhoneUA.prototype.INVITING_LOCAL_HANGINGUP_407_STATE="INVITING_LOCAL_HANGINGUP_407_STATE";ABTOPhoneUA.prototype.INVITED_INITIAL_STATE="INVITED_INITIAL_STATE";ABTOPhoneUA.prototype.INVITED_RINGING_STATE="INVITED_RINGING_STATE";ABTOPhoneUA.prototype.INVITED_ACCEPTED_STATE="INVITED_ACCEPTED_STATE";ABTOPhoneUA.prototype.INVITED_LOCAL_HANGINGUP_STATE="INVITED_LOCAL_HANGINGUP_STATE";ABTOPhoneUA.prototype.INVITED_LOCAL_HANGINGUP_407_STATE="INVITED_LOCAL_HANGINGUP_407_STATE";ABTOPhoneUA.prototype.INVITED_HANGUP_STATE="INVITED_HANGUP_STATE";ABTOPhoneUA.prototype.INVITING_FAILED_STATE="INVITING_FAILED_STATE";ABTOPhoneUA.prototype.HOLD_OFF="NO_HOLD_STATE";ABTOPhoneUA.prototype.HOLD_BY_ME="HOLD_BY_ME";ABTOPhoneUA.prototype.HOLD_BY_INTERLOCUTOR="HOLD_BY_INTERLOCUTOR";ABTOPhoneUA.prototype.setIceServers=function(a){this.iceServers=a};ABTOPhoneUA.prototype.setRemoteMedia=function(a){if(this.remoteVideo!=null){this.remoteVideo.pause();this.remoteVideo.src=null}this.remoteVideo=a};ABTOPhoneUA.prototype.setSipDomain=function(a){this.sipDomain=a};ABTOPhoneUA.prototype.setWSPort=function(a){this.WSPort=a};ABTOPhoneUA.prototype.setSecure=function(a){this.secure=a};ABTOPhoneUA.prototype.setSipDisplayName=function(a){this.sipDisplayName=a};ABTOPhoneUA.prototype.setSipUserName=function(a){this.sipUserName=a};ABTOPhoneUA.prototype.setSipLogin=function(a){this.sipLogin=a};ABTOPhoneUA.prototype.setSipPassword=function(a){this.sipPassword=a};ABTOPhoneUA.prototype.setConferenceFactory=function(a){this.confFactUri=a};ABTOPhoneUA.prototype.setMaxVideoBandwidth=function(a){this.maxVideoBandwidth=a};ABTOPhoneUA.prototype.getLinkedId=function(){return this.linkedId};ABTOPhoneUA.prototype.getCallInfo=function(){return this.callInfo};ABTOPhoneUA.prototype.getIsConference=function(){return this.isConference};ABTOPhoneUA.prototype.getConferenceId=function(){return this.conferenceId};ABTOPhoneUA.prototype.getConferenceMixerId=function(){return this.conferenceMixerId};ABTOPhoneUA.prototype.getParticipantId=function(){return this.participantId};ABTOPhoneUA.prototype.getParticipantToken=function(){return this.participantToken};ABTOPhoneUA.prototype.getToken=function(){return this.token};ABTOPhoneUA.prototype.onConnected=null;ABTOPhoneUA.prototype.onDisconnected=null;ABTOPhoneUA.prototype.onConnectionError=null;ABTOPhoneUA.prototype.onRegistered=null;ABTOPhoneUA.prototype.onUnregister=null;ABTOPhoneUA.prototype.onRegisterError=null;ABTOPhoneUA.prototype.onUnregisterError=null;ABTOPhoneUA.prototype.onReconnected=null;ABTOPhoneUA.prototype.onRemoteVideoStarted=null;ABTOPhoneUA.prototype.onRemoteVideoRemoved=null;ABTOPhoneUA.prototype.onRemoteVideoStopped=null;ABTOPhoneUA.prototype.onMessage=null;ABTOPhoneUA.prototype.onLocalVideoStarted=null;ABTOPhoneUA.prototype.onLocalVideoStartFailed=null;ABTOPhoneUA.prototype.onLocalVideoStopped=null;ABTOPhoneUA.prototype.onUpgraded=null;ABTOPhoneUA.prototype.onInvited=null;ABTOPhoneUA.prototype.onRinging=null;ABTOPhoneUA.prototype.onEstablished=null;ABTOPhoneUA.prototype.onEstablishError=null;ABTOPhoneUA.prototype.onHangUp=null;ABTOPhoneUA.prototype.onCallCleared=null;ABTOPhoneUA.prototype.onHold=null;ABTOPhoneUA.prototype.init=function(){if(this.inited){throw ("ABTOPhoneUA already inited")}if(this.secure){this.sipWsUrl="wss://"+this.sipDomain+":"+this.WSPort+"/ws";this.transport="WSS"}else{this.sipWsUrl="ws://"+this.sipDomain+":"+this.WSPort+"/ws";this.transport="WS"}this.conferenceId=null;this.conferenceMixerId=null;this.participantId=null;this.participantToken=null;this.linkedId=null;this.callInfo=null;this.recoverySession=null;this.isConference=false;this.isUpgraded=false;this.initSipRegisterStateMachine();this.initSipInvitingStateMachine();this.initSipInvitedStateMachine();this.initPeerConnectionStateMachine();this.initJainSipStack();this.inited=true};ABTOPhoneUA.prototype.reset=function(){this.conferenceId=null;this.conferenceMixerId=null;this.participantId=null;this.participantToken=null;this.linkedId=null;this.callInfo=null;this.recoverySession=null;this.isConference=false;this.isUpgraded=false;this.initSipRegisterStateMachine();this.initPeerConnectionStateMachine();this.initSipInvitingStateMachine();this.initSipInvitedStateMachine()};ABTOPhoneUA.prototype.reconnect=function(){console.debug("ABTOPhoneUA("+this.counter+"):reconnect() timer="+this.reconnectTimer);var a=this;if(this.reconnectTimer!=null){clearTimeout(this.reconnectTimer)}this.reconnectTimer=setTimeout(function(){a.reconnectCounter++;a.initSipRegisterStateMachine();a.initJainSipStack();clearTimeout(a.reconnectTimer)},Math.floor(Math.random()*2000))};ABTOPhoneUA.prototype.recover=function(){console.debug("ABTOPhoneUA("+this.counter+"):recover() invitingState:"+this.invitingState+" invitedState:"+this.invitedState);this.reconnectCounter=0;if(this.invitingState==this.INVITING_INITIAL_STATE&&this.invitedState==this.INVITED_INITIAL_STATE){}else{if(this.invitingState==this.INVITING_ACCEPTED_STATE||this.invitedState==this.INVITED_ACCEPTED_STATE){var b=this.remoteUser.toString();this.initSipInvitingStateMachine();this.initSipInvitedStateMachine();this.callee=b;this.sendInviteSipRequest(null)}else{if(this.invitingState==this.INVITING_STATE||this.invitingState==this.INVITING_407_STATE){if(this.inited&&this.onEstablishError){try{this.onEstablishError(1,500,"Disconnected")}catch(a){console.error("ABTOPhoneUA("+this.counter+"):onEstablishError(): caught exception:"+a)}}}this.conferenceId=null;this.conferenceMixerId=null;this.participantId=null;this.participantToken=null;this.linkedId=null;this.callInfo=null;this.recoverySession=null;this.isConference=false;this.isUpgraded=false;this.initPeerConnectionStateMachine();this.initSipInvitingStateMachine();this.initSipInvitedStateMachine()}}};ABTOPhoneUA.prototype.close=function(){try{this.bye()}catch(a){}try{this.unRegister()}catch(a){}clearTimeout(this.reconnectTimer);this.reconnectCounter=0;if(!this.registeredFlag){this.uninit()}else{this.unInitAfterUnRegister=true}};ABTOPhoneUA.prototype.uninit=function(){console.debug("ABTOPhoneUA("+this.counter+"):uninit()");try{this.reset()}catch(a){}try{this.closeJainSipStack()}catch(a){}this.inited=false};ABTOPhoneUA.prototype.initSipRegisterStateMachine=function(){console.debug("ABTOPhoneUA("+this.counter+"):initSipRegisterStateMachine()");if(this.refreshRegisterTimer){console.debug("ABTOPhoneUA("+this.counter+"):initSipRegisterStateMachine() clearing refreshRegisterTimer timeout");clearTimeout(this.refreshRegisterTimer)}this.registerState=this.UNREGISTERED_STATE;this.refreshRegisterTimer=null;this.registerAuthenticatedFlag=false;this.refreshRegisterFlag=false;this.jainSipRegisterSentRequest=null;this.registeredFlag=false;this.unregisterPendingFlag=false};ABTOPhoneUA.prototype.startLocalMedia=function(a,f,b){var e=this;this.stopLocalMedia();this.localVideo=a;if(!b){navigator.getUserMedia((f?f:{audio:useAudio,video:useVideo}),c,d)}else{c(b)}function c(g){console.log("User has granted access to local media.");e.localAudioVideoMediaStream=g;if(e.localVideo!=null){e.localVideo.srcObject=e.localAudioVideoMediaStream}if(e.localAudioVideoMediaStream!=null&&e.onLocalVideoStarted){e.onLocalVideoStarted(g)}}function d(g){console.error("Failed to get access to local media. Error code == "+g.code+", name == "+g.name+", message == "+g.message+".");if(!(g.name==="NotAllowedError"||g.name==="SecurityError")&&useVideo){console.log("Trying to get access to local media once more. This time to a microphone only.");useVideo=false;navigator.getUserMedia(({audio:useAudio,video:useVideo}),c,d)}else{if(e.onLocalVideoStartFailed){e.onLocalVideoStartFailed(g)}}}};ABTOPhoneUA.prototype.stopLocalMedia=function(){if(this.localVideo!=null){this.localVideo.pause();this.localVideo.src=null;this.localVideo=null}this.localAudioVideoMediaStream=null};ABTOPhoneUA.prototype.initSipInvitingStateMachine=function(){console.debug("ABTOPhoneUA("+this.counter+"):initSipInvitingStateMachine()");this.callee=null;this.invitingState=this.INVITING_INITIAL_STATE;this.jainSipInvitingSentRequest=null;this.jainSipInvitingDialog=null;this.jainSipInvitingTransaction=null;this.isConference=false;this.isUpgraded=false;this.conferenceId=null;this.conferenceMixerId=null;this.participantId=null;this.participantToken=null;this.localTag=null};ABTOPhoneUA.prototype.initSipInvitedStateMachine=function(){console.debug("ABTOPhoneUA("+this.counter+"):initSipInvitedStateMachine()");this.invitedState=this.INVITED_INITIAL_STATE;this.jainSipInvitedReceivedRequest=null;this.jainSipInvitedDialog=null;this.jainSipInvitedTransaction=null;this.isConference=false;this.isUpgraded=false;this.conferenceId=null;this.conferenceMixerId=null;this.participantId=null;this.participantToken=null;this.remoteTag=null};ABTOPhoneUA.prototype.initJainSipStack=function(){console.debug("ABTOPhoneUA("+this.counter+"):initJainSipStack()");this.sipFactory=new SipFactory();this.sipStack=this.sipFactory.createSipStack(this.sipUserAgentName,this.WSPort,this.transport);this.listeningPoint=this.sipStack.createListeningPoint(this.sipWsUrl);this.sipProvider=this.sipStack.createSipProvider(this.listeningPoint);this.sipProvider.addSipListener(this);this.headerFactory=this.sipFactory.createHeaderFactory();this.addressFactory=this.sipFactory.createAddressFactory();this.messageFactory=this.sipFactory.createMessageFactory(this.listeningPoint);this.sipStack.start()};ABTOPhoneUA.prototype.closeJainSipStack=function(){console.debug("ABTOPhoneUA("+this.counter+"):closeJainSipStack()");this.sipStack.stop();this.sipFactory=null;this.sipStack=null;this.listeningPoint=null;this.sipProvider=null;this.headerFactory=null;this.addressFactory=null;this.messageFactory=null};ABTOPhoneUA.prototype.initPeerConnectionStateMachine=function(){console.debug("ABTOPhoneUA("+this.counter+"):initPeerConnectionStateMachine()");if(this.peerConnection){console.debug("ABTOPhoneUA("+this.counter+"):initPeerConnectionStateMachine(): force peerConnection close");if(this.paused){this.toggleMediaStream();this.holdState=this.HOLD_OFF}if(this.remoteVideo!=null){this.remoteVideo.pause();this.remoteVideo.src=null}try{this.peerConnection.close()}catch(a){}if(this.inited&&this.onCallCleared){try{this.onCallCleared(1)}catch(a){console.error("ABTOPhoneUA("+this.counter+"):onCallCleared(): caught exception:"+a)}}}this.peerConnection=null;this.peerConnectionMessage=null;this.peerConnectionActionNeeded=false;this.peerConnectionState="new";this.peerConnectionIceStarted=false;this.peerConnectionMoreIceComing=true;this.peerConnectionIceCandidateCount=0;this.remoteAudioVideoMediaStream=null;this.lastReceivedSdpOfferString=null};ABTOPhoneUA.prototype.initSIPFunctionsStateMachine=function(){this.holdState=this.HOLD_OFF;this.holdClientTransaction=null;this.holdSentRequest=null;this.jainSipReferRequest=null;this.jainSipReferSentRequest=null;this.notifyReferRequest=null;this.referToAdressString=null;this.referredByUri=null};ABTOPhoneUA.prototype.fireOnHoldListener=function(){if(this.onHold){try{this.onHold(1,this.holdState!=this.HOLD_OFF,this.holdState==this.HOLD_BY_ME)}catch(a){console.error("ABTOPhoneUA("+this.counter+"):onHold(): caught exception:"+a)}}};ABTOPhoneUA.prototype.inviteReferToAddress=function(){if(this.referToAdressString!=null){this.invite(this.referToAdressString);this.referToAdressString=null}};ABTOPhoneUA.prototype.processDialogTerminated=function(a){console.debug("ABTOPhoneUA("+this.counter+"):processDialogTerminated()")};ABTOPhoneUA.prototype.processIOException=function(a){console.error("ABTOPhoneUA("+this.counter+"):processIOException()")};ABTOPhoneUA.prototype.processTimeout=function(a){if(arguments.length>1){return this.bye()}console.debug("ABTOPhoneUA("+this.counter+"):processTimeout() "+a)};ABTOPhoneUA.prototype.processTransactionTerminated=function(a){console.debug("ABTOPhoneUA("+this.counter+"):processTransactionTerminated()")};ABTOPhoneUA.prototype.processDisconnected=function(){console.error("ABTOPhoneUA("+this.counter+"):processDisconnected():inited="+this.inited);if(!this.inited){}else{if(this.reconnectCounter<3){this.reconnect()}else{if(this.onDisconnected){try{this.onDisconnected()}catch(a){console.error("ABTOPhoneUA("+this.counter+"):onDisconnected(): caught exception:"+a)}}this.reset()}}};ABTOPhoneUA.prototype.processConnectionError=function(a){console.error("ABTOPhoneUA("+this.counter+"):processConnectionError():error="+a);if(this.reconnectCounter<3){this.reconnect()}else{if(this.inited&&this.onConnectionError){try{this.onConnectionError(a)}catch(b){console.error("ABTOPhoneUA("+this.counter+"):onConnectionError(): caught exception:"+b)}}}};ABTOPhoneUA.prototype.processConnected=function(){console.debug("ABTOPhoneUA("+this.counter+"):processConnected()");if(this.reconnectCounter>0){this.register()}else{if(this.inited&&this.onConnected){try{this.onConnected()}catch(a){console.error("ABTOPhoneUA("+this.counter+"):onConnected(): caught exception:"+a)}if(this.registerAfterInit){this.register();this.registerAfterInit=false}}}};ABTOPhoneUA.prototype.processResponse=function(a){console.debug("ABTOPhoneUA("+this.counter+"):processResponse()");var b=a.getResponse();if(b.getCSeq().getMethod()=="REGISTER"){this.handleStateMachineRegisterResponseEvent(a)}else{if(b.getCSeq().getMethod()=="REFER"){this.handleStateMachineReferResponseEvent(a)}else{if(b.getCSeq().getMethod()=="NOTIFY"){this.handleStateMachineNotifyResponseEvent(a)}else{if(b.getCSeq().getMethod()=="MESSAGE"){this.handleStateMachineMessageResponseEvent(a)}else{if(this.invitingState!=this.INVITING_INITIAL_STATE){this.handleStateMachineInvitingResponseEvent(a)}else{if(this.invitedState!=this.INVITED_INITIAL_STATE){this.handleStateMachineInvitedResponseEvent(a)}else{console.debug("ABTOPhoneUA("+this.counter+"):processResponse(): response ignored")}}}}}}};ABTOPhoneUA.prototype.processRequest=function(b){console.debug("ABTOPhoneUA("+this.counter+"):processRequest()");var a=b.getRequest();var i=a.getMethod();console.log(a,i);if(i=="INVITE"){if(this.invitedState==this.INVITED_ACCEPTED_STATE||this.invitingState==this.INVITING_ACCEPTED_STATE){var c=a.getContent();if(c&&c.indexOf("a=connection:existing")<0){this.processHoldRequest(b)}else{this.processUpdateInviteRequest(b)}}else{if(this.invitingState!=this.INVITING_INITIAL_STATE){console.log("LOG: invitingState");var j=a.createResponse(480,"Temporarily Unavailable");j.addHeader(this.jainSipRegisterSentRequest.getHeader("User-Agent"));b.getServerTransaction().sendMessage(j)}else{if(this.invitedState!=this.INVITED_INITIAL_STATE){console.log("LOG: invitedState");j=a.createResponse(480,"Temporarily Unavailable");j.addHeader(this.jainSipRegisterSentRequest.getHeader("User-Agent"));b.getServerTransaction().sendMessage(j)}else{if(a.hasHeader("X-Conference-ID")){this.isConference=true;this.conferenceId=a.getHeader("X-Conference-ID").value;if(a.hasHeader("X-Conference-Mixer-ID")){this.conferenceMixerId=parseInt(a.getHeader("X-Conference-Mixer-ID").value)}if(a.hasHeader("X-Participant-ID")){this.participantId=parseInt(a.getHeader("X-Participant-ID").value)}if(a.hasHeader("X-Participant-Token")){this.participantToken=a.getHeader("X-Participant-Token").value}}console.log("LOG: handle incoming call");this.handleStateMachineInvitedRequestEvent(b)}}}}else{if((i=="BYE")||(i=="ACK")){if(i=="BYE"){this.isConference=false;this.isUpgraded=false;this.conferenceId=null;this.conferenceMixerId=null;this.participantId=null;this.participantToken=null}if(this.invitingState!=this.INVITING_INITIAL_STATE){this.handleStateMachineInvitingRequestEvent(b)}else{if(this.invitedState!=this.INVITED_INITIAL_STATE){this.handleStateMachineInvitedRequestEvent(b)}else{console.warn("SimpleWebRtcSipPhone:processRequest(): request ignored")}}}else{if(i=="CANCEL"){this.isConference=false;this.isUpgraded=false;this.conferenceId=null;this.conferenceMixerId=null;this.participantId=null;this.participantToken=null;this.handleStateMachineInvitedRequestEvent(b)}else{if(i=="UPDATE"){if(a.hasHeader("X-Conference-ID")){if(!this.isConference){this.isUpgraded=true}this.isConference=true;this.conferenceId=a.getHeader("X-Conference-ID").value;if(a.hasHeader("X-Conference-Mixer-ID")){this.conferenceMixerId=parseInt(a.getHeader("X-Conference-Mixer-ID").value)}if(a.hasHeader("X-Participant-ID")){this.participantId=parseInt(a.getHeader("X-Participant-ID").value)}if(a.hasHeader("X-Participant-Token")){this.participantToken=a.getHeader("X-Participant-Token").value}}this.handleStateMachineUpdateRequestEvent(b)}else{if(i=="REFER"){try{var f=a.createResponse(202,"Accepted");f.addHeader(this.jainSipContactHeader);b.getServerTransaction().sendResponse(f)}catch(d){console.error("ABTOPhoneUA("+this.counter+"):sending 202 refer : caught exception:"+exception)}this.jainSipReferRequest=a;this.sendNotifyReferRequest(b)}else{if(i=="NOTIFY"){try{var h=a.createResponse(200,"OK");b.getServerTransaction().sendResponse(h)}catch(d){console.error("ABTOPhoneUA("+this.counter+"):send 200 OK Notify : caught exception:"+exception)}this.processNotifyRequest(a)}else{if(i=="MESSAGE"){try{var h=a.createResponse(200,"OK");b.getServerTransaction().sendResponse(h)}catch(d){console.error("ABTOPhoneUA("+this.counter+"):send 200 OK Message : caught exception:"+exception)}if(this.onMessage){try{this.onMessage(a.getFromHeader().getAddress().encodeWithoutScheme(),a.getContent())}catch(g){console.error("ABTOPhoneUA("+this.counter+"):onMessage(): caught exception:"+g)}}}else{if(i=="OPTIONS"){try{var h=a.createResponse(200,"OK");h.addHeader(this.jainSipContactHeader);h.addHeader(this.jainSipUserAgentHeader);b.getServerTransaction().sendResponse(h)}catch(d){console.error("ABTOPhoneUA("+this.counter+"):sending 200 OK OPTIONS: caught exception:"+exception)}}else{console.warn("SimpleWebRtcSipPhone:processResponse(): request ignored")}}}}}}}}};ABTOPhoneUA.prototype.processHoldRequest=function(b){console.log("hold request");var a=this.peerConnection.localDescription.sdp;if(this.maxVideoBandwidth){a=a.replace(/(m=video.*\r\nc=IN.*\r\n)/m,"$1b=AS:"+this.maxVideoBandwidth+"\r\n")}if(!this.paused){a=a.replace(/a=sendrecv\r\n/g,"a=recvonly\r\n")}var d=b.getRequest().createResponse(200,"OK");d.addHeader(this.jainSipContactHeader);d.addHeader(this.jainSipRegisterSentRequest.getHeader("User-Agent"));d.setMessageContent("application","sdp",a);var c=b.getServerTransaction();c.sendResponse(d);this.toggleMediaStream();this.holdState=this.paused?this.HOLD_BY_INTERLOCUTOR:this.HOLD_OFF;this.fireOnHoldListener()};ABTOPhoneUA.prototype.processUpdateInviteRequest=function(a){var b=a.getRequest().createResponse(200,"OK");b.addHeader(this.jainSipContactHeader);b.addHeader(this.jainSipRegisterSentRequest.getHeader("User-Agent"));b.setMessageContent("application","sdp",this.peerConnection.localDescription.sdp);a.getServerTransaction().sendResponse(b)};ABTOPhoneUA.prototype.processNotifyRequest=function(b){var c=b.getHeader(SIPRequest.prototype.EventHeader);if(c.getEventType().toLowerCase()=="refer"){var a=b.getHeader("Subscription-State");if(a&&a.value&&a.value.toLowerCase().substr(0,6)=="active"){this.bye()}}};ABTOPhoneUA.prototype.sendNotifyReferRequest=function(c){try{var g=c.getRequest().getFromHeader();var m=c.getRequest().getToHeader();var j=this.getInterlocutorsAddress();var a=this.addressFactory.createSipURI_user_host(null,j);var k=this.headerFactory.createCSeqHeader(2,"NOTIFY");var p=c.getRequest().getCallIdHeader();var f=this.headerFactory.createMaxForwardsHeader(70);var d=this.headerFactory.createToHeader(g.getAddress(),g.getTag());var i=this.headerFactory.createFromHeader(m.getAddress(),m.getTag());var l=this.listeningPoint.getViaHeader();var o=this.headerFactory.createContentTypeHeader("message","sipfrag");var h="SIP/2.0 100 Trying";this.notifyReferRequest=this.messageFactory.createRequest(a,"NOTIFY",p,k,i,d,l,f,o,h);var e=this.headerFactory.createEventHeader("refer");this.messageFactory.addHeader(this.notifyReferRequest,e);this.messageFactory.addHeader(this.notifyReferRequest,this.jainSipContactHeader);this.messageFactory.addHeader(this.notifyReferRequest,this.jainSipUserAgentHeader);this.notifyReferRequest.addHeader("Subscription-State: active;expires=60");var n=this.sipProvider.getNewClientTransaction(this.notifyReferRequest);this.notifyReferRequest.setTransaction(n);c.getServerTransaction().getDialog().sendRequest(n)}catch(b){console.error("ABTOPhoneUA("+this.counter+"): send NOTIFY on REFER: caught exception:"+b)}};ABTOPhoneUA.prototype.sendNotifyReferDoneRequest=function(r,i){try{var o=r.encodeWithoutScheme();var d=this.addressFactory.createSipURI_user_host(null,o);var b=this.addressFactory.createAddress_name_uri(null,d);var s=this.headerFactory.createToHeader(b,null);var a=this.sipUserName+"@"+this.sipDomain;var n=this.addressFactory.createSipURI_user_host(null,a);var t=this.addressFactory.createAddress_name_uri(this.sipDisplayName,n);var q=new Date().getTime();var l=this.headerFactory.createFromHeader(t,q);var k=this.headerFactory.createCSeqHeader(3,"NOTIFY");var m=this.referLastOKResponce.getCallIdHeader();var h=this.headerFactory.createMaxForwardsHeader(70);var e=this.listeningPoint.getViaHeader();var p=this.headerFactory.createContentTypeHeader("message","sipfrag");var f=i.encode();this.notifyReferDoneRequest=this.messageFactory.createRequest(r,"NOTIFY",m,k,l,s,e,h,p,f);var g=this.headerFactory.createEventHeader("refer");this.messageFactory.addHeader(this.notifyReferDoneRequest,g);this.messageFactory.addHeader(this.notifyReferDoneRequest,this.jainSipContactHeader);this.messageFactory.addHeader(this.notifyReferDoneRequest,this.jainSipUserAgentHeader);this.notifyReferDoneRequest.addHeader("Subscription-State: terminated;reason=noresource");var j=this.sipProvider.getNewClientTransaction(this.notifyReferDoneRequest);this.notifyReferDoneRequest.setTransaction(j);j.sendRequest()}catch(c){console.error("ABTOPhoneUA("+this.counter+"): send NOTIFY on call transfer done: caught exception:"+c)}};ABTOPhoneUA.prototype.initAndRegister=function(){if(!this.inited){this.registerAfterInit=true;this.init()}else{this.register()}};ABTOPhoneUA.prototype.register=function(){console.debug("ABTOPhoneUA("+this.counter+"):register(): sipDomain="+this.sipDomain);console.debug("ABTOPhoneUA("+this.counter+"):register(): WSPort="+this.WSPort);console.debug("ABTOPhoneUA("+this.counter+"):register(): sipDisplayName="+this.sipDisplayName);console.debug("ABTOPhoneUA("+this.counter+"):register(): sipUserName="+this.sipUserName);console.debug("ABTOPhoneUA("+this.counter+"):register(): sipLogin="+this.sipLogin);console.debug("ABTOPhoneUA("+this.counter+"):register(): sipPassword="+this.sipPassword);if(this.registerState==this.UNREGISTERED_STATE){try{this.jainSipContactHeader=this.listeningPoint.createContactHeader(this.sipUserName);if(this.reconnectCounter>0){this.jainSipContactHeader.setQuotedParameter("reconnect",this.token)}this.jainSipUserAgentHeader=this.headerFactory.createUserAgentHeader(this.sipStack.getUserAgent());var a=this.sipUserName+"@"+this.sipDomain;var n=this.headerFactory.createCSeqHeader(0,"REGISTER");var q=this.headerFactory.createCallIdHeader();var b=this.headerFactory.createExpiresHeader(3600);var i=this.headerFactory.createMaxForwardsHeader(70);var d=this.addressFactory.createSipURI_user_host(null,this.sipDomain);var m=this.headerFactory.createHeaders("Allow: INVITE,UPDATE,ACK,CANCEL,BYE,NOTIFY,OPTIONS,MESSAGE,REFER");var c=this.addressFactory.createSipURI_user_host(null,a);var j=this.addressFactory.createAddress_name_uri(null,c);var f=new Date();var p=f.getTime();var k=this.headerFactory.createFromHeader(j,p);var g=this.headerFactory.createToHeader(j,null);var o=this.listeningPoint.getViaHeader();var h=this.messageFactory.createRequest(d,"REGISTER",q,n,k,g,o,i);this.messageFactory.addHeader(h,b);this.messageFactory.addHeader(h,this.jainSipUserAgentHeader);this.messageFactory.addHeader(h,m);this.messageFactory.addHeader(h,this.jainSipContactHeader);this.jainSipRegisterSentRequest=h;var l=this.sipProvider.getNewClientTransaction(h);h.setTransaction(l);l.sendRequest();this.registerState=this.REGISTERING_STATE}catch(e){this.initSipRegisterStateMachine();console.error("ABTOPhoneUA("+this.counter+"):register(): caught exception:"+e);return false}}else{console.error("ABTOPhoneUA("+this.counter+"):register(): bad state, action register unauthorized");return false}return true};ABTOPhoneUA.prototype.keepAliveRegister=function(){console.debug("ABTOPhoneUA("+this.counter+"):keepAliveRegister() token:"+this.token);if(this.registerState==this.REGISTERED_STATE){this.refreshRegisterTimer=null;this.registerState=this.REGISTER_REFRESHING_STATE;if(this.token!=null){this.jainSipRegisterSentRequest.getContactHeader().setQuotedParameter("token",this.token)}this.jainSipRegisterSentRequest=this.setNewViaHeader(this.jainSipRegisterSentRequest);var a=this.sipProvider.getNewClientTransaction(this.jainSipRegisterSentRequest);this.jainSipRegisterSentRequest.setTransaction(a);a.sendRequest()}else{throw"ABTOPhoneUA("+this.counter+"):keepAliveRegister(): bad state, action keep alive register unauthorized"}};ABTOPhoneUA.prototype.unRegister=function(){console.debug("ABTOPhoneUA("+this.counter+"):unRegister()");if(this.registerState==this.REGISTERED_STATE){this.registerState=this.UNREGISTERING_STATE;if(this.refreshRegisterTimer!=null){console.debug("ABTOPhoneUA("+this.counter+"):unRegister() clearing refreshRegisterTimer timeout");clearTimeout(this.refreshRegisterTimer)}this.jainSipRegisterSentRequest.getExpires().setExpires(0);this.jainSipRegisterSentRequest=this.jainSipRegisterSentRequest=this.setNewViaHeader(this.jainSipRegisterSentRequest);var a=this.sipProvider.getNewClientTransaction(this.jainSipRegisterSentRequest);this.jainSipRegisterSentRequest.setTransaction(a);a.sendRequest()}else{if(this.registerState==this.UNREGISTERED_STATE){console.warn("ABTOPhoneUA("+this.counter+"):unRegister(): bad state, action keep alive register unauthorized")}else{this.unregisterPendingFlag=true}}};ABTOPhoneUA.prototype.setNewViaHeader=function(d){if(d instanceof SIPRequest){var a=new SIPRequest();a.setMethod(d.getMethod());a.setRequestURI(d.getRequestURI())}else{a=new SIPResponse}var b=d.getHeaders();for(var c=0;c<b.length;c++){a.addHeader(b[c])}a.setCallId(d.getCallId());a.setVia(this.listeningPoint.getViaHeader());a.setFrom(d.getFrom());a.setTo(d.getTo());a.setMaxForwards(d.getMaxForwards());if(null!=d.getContent()){a.setContent(d.getContent(),d.getContentTypeHeader())}return a};ABTOPhoneUA.prototype.addAuthHeader=function(b,c){b.removeHeader(Authorization.prototype.NAME);b.removeHeader(ProxyAuthorization.prototype.PROXY_AUTHORIZATION);var a=this.headerFactory.createAuthorizationHeader(c,b,this.sipPassword,this.sipLogin);b=this.setNewViaHeader(b);return this.messageFactory.addHeader(b,a)};ABTOPhoneUA.prototype.handleStateMachineReferResponseEvent=function(b){console.debug("ABTOPhoneUA("+this.counter+"):handleStateMachineReferResponseEvent()");var c=b.getResponse();var a=parseInt(c.getStatusCode());if(a==401||a==407){this.jainSipReferSentRequest=this.addAuthHeader(this.jainSipReferSentRequest,c);this.jainSipReferTransaction=this.sipProvider.getNewClientTransaction(this.jainSipReferSentRequest);this.jainSipReferSentRequest.setTransaction(this.jainSipReferTransaction);this.jainSipReferTransaction.sendRequest()}};ABTOPhoneUA.prototype.handleStateMachineNotifyResponseEvent=function(e){console.debug("ABTOPhoneUA("+this.counter+"):handleStateMachineNotifyResponseEvent()");var f=e.getResponse();var d=parseInt(f.getStatusCode());if(d==401||d==407){var c=e.getOriginalTransaction().getRequest();c=this.addAuthHeader(c,f);var b=this.sipProvider.getNewClientTransaction(c);c.setTransaction(b);e.getOriginalTransaction().getDialog().sendRequest(b)}else{if(d==200){var c=e.getOriginalTransaction().getRequest();if(c.getHeader(EventHeader.prototype.NAME).getEventType()=="refer"){var a=this.jainSipReferRequest.getHeader(ReferTo.prototype.NAME).getAddress();this.referToAdressString=a.encodeWithoutScheme();this.referredByUri=this.remoteUser;this.referLastOKResponce=f}}}};ABTOPhoneUA.prototype.handleStateMachineMessageResponseEvent=function(d){console.debug("ABTOPhoneUA("+this.counter+"):handleStateMachineNotifyResponseEvent()");var e=d.getResponse();var c=parseInt(e.getStatusCode());if(c==401||c==407){var b=d.getOriginalTransaction().getRequest();b=this.addAuthHeader(b,e);var a=this.sipProvider.getNewClientTransaction(b);b.setTransaction(a);a.sendRequest()}};ABTOPhoneUA.prototype.handleStateMachineRegisterResponseEvent=function(f){console.debug("ABTOPhoneUA("+this.counter+"):handleStateMachineRegisterResponseEvent(): this.registerState="+this.registerState);var h=f.getResponse();var d=parseInt(h.getStatusCode());if(this.registerState==this.UNREGISTERED_STATE){console.error("ABTOPhoneUA("+this.counter+"):handleStateMachineRegisterResponseEvent(): bad state, SIP response ignored")}else{if((this.registerState==this.REGISTERING_STATE)||(this.registerState==this.REGISTER_REFRESHING_STATE)||this.registerState==this.REGISTERING_401_STATE){if(d<200){console.debug("ABTOPhoneUA("+this.counter+"):handleStateMachineRegisterResponseEvent(): 1XX response ignored")}else{if((d==401||d==407)&&this.registerState!=this.REGISTERING_401_STATE){this.registerState=this.REGISTERING_401_STATE;this.jainSipRegisterSentRequest=this.addAuthHeader(this.jainSipRegisterSentRequest,h);var a=this.sipProvider.getNewClientTransaction(this.jainSipRegisterSentRequest);this.jainSipRegisterSentRequest.setTransaction(a);a.sendRequest()}else{if(d==200){this.registerState=this.REGISTERED_STATE;if(!this.registeredFlag){this.registeredFlag=true;console.debug("ABTOPhoneUA("+this.counter+"):handleStateMachineRegisterResponseEvent(): this.registeredFlag=true");var b=h.getContactHeader();this.token=b.getParameterValue("token");console.debug("ABTOPhoneUA("+this.counter+"):handleStateMachineRegisterResponseEvent(): got token:"+this.token);if(this.reconnectCounter>0){if(this.onReconnected){try{this.onReconnected()}catch(g){console.error("ABTOPhoneUA("+this.counter+"):onReconnected(): caught exception:"+g)}}this.recover()}else{if(this.inited&&this.onRegistered){try{this.onRegistered()}catch(g){console.error("ABTOPhoneUA("+this.counter+"):onRegistered(): caught exception:"+g)}}}}var c=this;console.debug("ABTOPhoneUA("+this.counter+"):handleStateMachineRegisterResponseEvent() schedule keepAliveRegister to trigger in 30m");this.refreshRegisterTimer=setTimeout(function(){c.keepAliveRegister()},1800000);if(this.unregisterPendingFlag){this.unregisterPendingFlag=false;this.unRegister()}}else{console.error("Registration Failed:"+h.getStatusCode()+"  "+h.getStatusLine().getReasonPhrase());if(this.inited&&this.onRegisterError){try{this.onRegisterError(h.getStatusCode()+"  "+h.getStatusLine().getReasonPhrase())}catch(g){console.error("ABTOPhoneUA("+this.counter+"):onRegisterError(): caught exception:"+g)}}this.initSipRegisterStateMachine()}}}}else{if(this.registerState==this.REGISTERED_STATE){console.error("ABTOPhoneUA("+this.counter+"):handleStateMachineRegisterResponseEvent(): bad state, SIP response ignored")}else{if(this.registerState==this.UNREGISTERING_STATE){if(d<200){console.debug("ABTOPhoneUA("+this.counter+"):handleStateMachineRegisterResponseEvent(): 1XX response ignored")}else{if(d==401){this.registerState=this.UNREGISTERING_401_STATE;this.jainSipRegisterSentRequest=this.addAuthHeader(this.jainSipRegisterSentRequest,h);var a=this.sipProvider.getNewClientTransaction(this.jainSipRegisterSentRequest);this.jainSipRegisterSentRequest.setTransaction(a);a.sendRequest()}else{if(d==200){this.registerState=this.UNREGISTERED_STATE;if(this.registeredFlag){console.debug("ABTOPhoneUA("+this.counter+"):handleStateMachineRegisterResponseEvent(): this.registeredFlag=false");this.registeredFlag=false;if(this.inited&&this.onUnregistered){try{this.onUnregistered()}catch(g){console.error("ABTOPhoneUA("+this.counter+"):onUnregistered(): caught exception:"+g)}}if(this.unInitAfterUnRegister){this.uninit();this.unInitAfterUnRegister=false}}}else{console.error("UnRegistration Failed:"+h.getStatusCode()+"  "+h.getStatusLine().getReasonPhrase());if(this.inited&&this.onUnregisterError){try{this.onUnregisterError()}catch(g){console.error("ABTOPhoneUA("+this.counter+"):onUnregisterError(): caught exception:"+g)}}this.initSipRegisterStateMachine()}}}}else{if(this.registerState==this.UNREGISTERING_401_STATE){if(d<200){console.debug("ABTOPhoneUA("+this.counter+"):handleStateMachineRegisterResponseEvent(): 1XX response ignored")}else{if(d==200){this.registerState=this.UNREGISTERED_STATE;if(this.registeredFlag){console.debug("ABTOPhoneUA("+this.counter+"):handleStateMachineRegisterResponseEvent(): this.registeredFlag=false");this.registeredFlag=false;if(this.inited&&this.onUnregistered){try{this.onUnregistered()}catch(g){console.error("ABTOPhoneUA("+this.counter+"):onUnregistered(): caught exception:"+g)}}if(this.unInitAfterUnRegister){this.uninit();this.unInitAfterUnRegister=false}}}else{console.error("UnRegistration Failed:"+h.getStatusCode()+"  "+h.getStatusLine().getReasonPhrase());if(this.inited&&this.onUnregisterError){try{this.onUnregisterError()}catch(g){console.error("ABTOPhoneUA("+this.counter+"):onEstablishError(): caught exception:"+g)}}this.initSipRegisterStateMachine()}}}else{if(this.registerState==this.UNREGISTERED_STATE){console.error("ABTOPhoneUA("+this.counter+"):handleStateMachineRegisterResponseEvent(): bad state, SIP response ignored")}else{console.error("ABTOPhoneUA("+this.counter+"):handleStateMachineRegisterResponseEvent(): bad state, SIP response ignored")}}}}}}};ABTOPhoneUA.prototype.call=function(a){this.conferenceId=null;this.conferenceMixerId=null;this.participantId=null;this.participantToken=null;this.linkedId=null;this.callInfo=null;this.recoverySession=null;this.isUpgraded=false;this.isConference=false;this.resourceList=null;if(a){return this.invite(a)}else{return false}};ABTOPhoneUA.prototype.conference=function(a){this.conferenceId=null;this.conferenceMixerId=null;this.participantId=null;this.participantToken=null;this.linkedId=null;this.callInfo=null;this.recoverySession=null;this.isUpgraded=false;this.isConference=true;this.resourceList='<?xml version="1.0" encoding="UTF-8"?>';this.resourceList+='<resource-lists xmlns="urn:ietf:params:xml:ns:resource-lists" xmlns:cp="urn:ietf:params:xml:ns:copycontrol">';this.resourceList+="<list>";for(var b=0;b<a.length;b++){var c=a[b];if(c.substring(0,4)!="sip:"){c="sip:"+c}this.resourceList+='<entry uri="'+c+'" cp:copyControl="to"/>'}this.resourceList+="</list>";this.resourceList+="</resource-lists>";this.createPeerConnectionWithoutStunServer();return this.invite(this.confFactUri)};ABTOPhoneUA.prototype.join=function(a){this.conferenceId=null;this.conferenceMixerId=null;this.participantId=null;this.participantToken=null;this.linkedId=null;this.callInfo=null;this.recoverySession=null;this.isUpgraded=false;this.isConference=true;this.resourceList=null;this.createPeerConnectionWithoutStunServer();return this.invite(a)};ABTOPhoneUA.prototype.invite=function(d){console.debug("ABTOPhoneUA("+this.counter+"):invite():to: "+d);if(this.invitingState==this.INVITING_INITIAL_STATE){try{var c={offerToReceiveAudio:useAudio,offerToReceiveVideo:useVideo};this.callee=d;console.log("this.callee: ",this.callee);this.createPeerConnection();if(this.localAudioVideoMediaStream!=null){this.peerConnection.addStream(this.localAudioVideoMediaStream,null)}var a=this;this.peerConnection.createOffer(function(e){a.onPeerConnectionCreateOfferSuccessCallback(e)},function(e){a.onPeerConnectionCreateOfferErrorCallback(e)},c)}catch(b){console.error("ABTOPhoneUA("+this.counter+"):call(): caught exception:"+b);this.initPeerConnectionStateMachine();this.initSipInvitingStateMachine();return false}}else{console.error("ABTOPhoneUA("+this.counter+"):call(): bad state, action call unauthorized");return false}return true};ABTOPhoneUA.prototype.sendInviteSipRequest=function(b){console.debug("ABTOPhoneUA("+this.counter+"):sendInviteSipRequest()");try{var d=this.sipUserName+"@"+this.sipDomain;var r=this.callee;console.debug("ABTOPhoneUA("+this.counter+"):sendInviteSipRequest(from:"+d+",to:"+r+")");var c=new Date();var m=this.headerFactory.createCSeqHeader(0,"INVITE");var o=this.headerFactory.createCallIdHeader();var l=this.headerFactory.createMaxForwardsHeader(70);var e=this.addressFactory.createSipURI_user_host(null,r);var i=this.headerFactory.createHeaders("Allow: INVITE,ACK,CANCEL,BYE,REFER");var p=this.addressFactory.createSipURI_user_host(null,d);var v=this.addressFactory.createAddress_name_uri(this.sipDisplayName,p);this.localTag=c.getTime();var n=this.headerFactory.createFromHeader(v,this.localTag);var h=this.addressFactory.createSipURI_user_host(null,r);var f=this.addressFactory.createAddress_name_uri(null,h);var t=this.headerFactory.createToHeader(f,null);var j=this.listeningPoint.getViaHeader();var k=null;var s=null;this.remoteUser=h;if(this.isConference&&this.resourceList!=null){var q="----"+new Date().getTime();s=this.headerFactory.createContentTypeHeader("multipart","mixed");s.setQuotedParameter("boundary",q);k="--"+q+"\r\n";k+="Content-Type: application/sdp\r\n\r\n";k+=b;k+="\r\n--"+q+"\r\n";k+="Content-Type: application/resource-lists+xml\r\n";k+="Content-Disposition: recipient-list\r\n\r\n";k+=this.resourceList;k+="\r\n--"+q+"--\r\n"}else{s=this.headerFactory.createContentTypeHeader("application","sdp");k=b}if(b!=null){this.jainSipInvitingSentRequest=this.messageFactory.createRequest(e,"INVITE",o,m,n,t,j,l,s,k)}else{this.jainSipInvitingSentRequest=this.messageFactory.createRequest(e,"INVITE",o,m,n,t,j,l)}if(this.referredByUri!=null){var u=this.addressFactory.createAddress_name_uri(null,this.referredByUri);var a=this.headerFactory.createReferredByHeader(u);this.messageFactory.addHeader(this.jainSipInvitingSentRequest,a)}if(this.jainSipUserAgentHeader==null){this.jainSipUserAgentHeader=this.headerFactory.createUserAgentHeader(this.sipStack.getUserAgent())}if(this.jainSipContactHeader==null){this.jainSipContactHeader=this.listeningPoint.createContactHeader(this.sipUserName)}this.messageFactory.addHeader(this.jainSipInvitingSentRequest,this.jainSipUserAgentHeader);this.messageFactory.addHeader(this.jainSipInvitingSentRequest,i);this.messageFactory.addHeader(this.jainSipInvitingSentRequest,this.jainSipContactHeader);if(this.isConference&&this.resourceList!=null){this.jainSipInvitingSentRequest.addHeader("Require: recipient-list-invite")}if(this.recoverySession!=null){this.jainSipInvitingSentRequest.addHeader("X-Recovery-Session: "+this.recoverySession)}this.invitingState=this.INVITING_STATE;this.jainSipInvitingTransaction=this.sipProvider.getNewClientTransaction(this.jainSipInvitingSentRequest);this.jainSipInvitingSentRequest.setTransaction(this.jainSipInvitingTransaction);this.jainSipInvitingTransaction.sendRequest()}catch(g){console.error("ABTOPhoneUA("+this.counter+"):sendInviteSipRequest(): caught exception:"+g);this.initPeerConnectionStateMachine();this.initSipInvitingStateMachine();throw ("ABTOPhoneUA("+this.counter+"):sendInviteSipRequest(): caught exception:"+g)}};ABTOPhoneUA.prototype.send200OKSipResponse=function(d){console.debug("ABTOPhoneUA("+this.counter+"):send200OKSipResponse()");try{this.invitedState=this.INVITED_ACCEPTED_STATE;var c=this.jainSipInvitedReceivedRequest.createResponse(200,"OK");this.localTag=c.getToHeader().getTag();c.addHeader(this.jainSipContactHeader);c.addHeader(this.jainSipUserAgentHeader);c.setMessageContent("application","sdp",d);this.jainSipInvitedTransaction.sendResponse(c);if(this.inited&&this.peerConnectionState!="preparing-update"){if(this.checkConnection(twoByteHigh)&&this.onEstablished){try{this.onEstablished(1,this.remoteUser.toString())}catch(b){console.error("ABTOPhoneUA("+this.counter+"):onEstablished() caught exception:"+b)}}}if(this.inited&&this.onUpgraded&&this.peerConnectionState=="preparing-update"&&this.isUpgraded){try{this.onUpgraded(1);this.isUpgraded=false}catch(b){console.error("ABTOPhoneUA("+this.counter+"):onUpgraded(): caught exception:"+b)}}}catch(a){this.initPeerConnectionStateMachine();this.initSipInvitingStateMachine();console.error("ABTOPhoneUA("+this.counter+"):send200OKSipResponse(): caught exception:"+a);throw ("ABTOPhoneUA("+this.counter+"):send200OKSipResponse(): caught exception:"+a)}};ABTOPhoneUA.prototype.hold=function(){console.debug("ABTOPhoneUA("+this.counter+"):hold()");try{var b=this.peerConnection.localDescription.sdp;if(this.maxVideoBandwidth){b=b.replace(/(m=video.*\r\nc=IN.*\r\n)/m,"$1b=AS:"+this.maxVideoBandwidth+"\r\n")}if(!this.paused){b=b.replace(/a=sendrecv\r\n/g,"a=sendonly\r\n")}var c=b.indexOf(" IN IP4");b=[b.slice(0,c),Date.now().toString(),b.slice(c)].join("");if(this.invitingState==this.INVITING_ACCEPTED_STATE){this.holdSentRequest=this.jainSipInvitingDialog.createRequest("INVITE")}else{this.holdSentRequest=this.jainSipInvitedDialog.createRequest("INVITE")}var e=this.headerFactory.createHeaders("Allow: INVITE,ACK,CANCEL,BYE,REFER");var a=this.headerFactory.createContentTypeHeader("application","sdp");this.messageFactory.addHeader(this.holdSentRequest,this.jainSipUserAgentHeader);this.messageFactory.addHeader(this.holdSentRequest,e);this.messageFactory.addHeader(this.holdSentRequest,this.jainSipContactHeader);this.holdSentRequest.setContent(b,a);this.holdClientTransaction=this.sipProvider.getNewClientTransaction(this.holdSentRequest);this.holdSentRequest.setTransaction(this.holdClientTransaction);if(this.invitingState==this.INVITING_ACCEPTED_STATE){this.jainSipInvitingDialog.sendRequest(this.holdClientTransaction)}else{this.jainSipInvitedDialog.sendRequest(this.holdClientTransaction)}}catch(d){console.debug("ABTOPhoneUA("+this.counter+"):hold(): caught exception:"+d)}};ABTOPhoneUA.prototype.getInterlocutorsAddress=function(){return this.remoteUser.encodeWithoutScheme()};ABTOPhoneUA.prototype.holdAuthenticateRequest=function(b){try{this.holdSentRequest=this.addAuthHeader(this.holdSentRequest,b);this.holdClientTransaction=this.sipProvider.getNewClientTransaction(this.holdSentRequest);this.holdSentRequest.setTransaction(this.holdClientTransaction);this.holdClientTransaction.sendRequest()}catch(a){console.error("ABTOPhoneUA("+this.counter+"):holdAuthenticateRequest(): caught exception:"+a)}};ABTOPhoneUA.prototype.sendACK=function(c){try{var e=c.getOriginalTransaction().getDialog();e.setRemoteTarget(c.getResponse().getHeader("Contact"));var d=c.getOriginalTransaction().createAck();var a=new Number(d.getCSeq().getSeqNumber());d.getCSeq().setSeqNumber(a+1);e.incrementLocalSequenceNumber();e.sendAck(d)}catch(b){console.error("ABTOPhoneUA("+this.counter+"):sendACK(): caught exception:"+b)}};ABTOPhoneUA.prototype.mute=function(){if(this.localAudioVideoMediaStream){this.localAudioVideoMediaStream.getAudioTracks().forEach(function(a){a.enabled=false})}};ABTOPhoneUA.prototype.unmute=function(){if(this.localAudioVideoMediaStream){this.localAudioVideoMediaStream.getAudioTracks().forEach(function(a){a.enabled=true})}};ABTOPhoneUA.prototype.toggleMediaStream=function(){try{if(this.paused){this.localAudioVideoMediaStream.getAudioTracks().forEach(function(b){b.enabled=true});this.localAudioVideoMediaStream.getVideoTracks().forEach(function(b){b.enabled=true});this.remoteAudioVideoMediaStream.getAudioTracks().forEach(function(b){b.enabled=true});this.remoteAudioVideoMediaStream.getVideoTracks().forEach(function(b){b.enabled=true})}else{this.localAudioVideoMediaStream.getAudioTracks().forEach(function(b){b.enabled=false});this.localAudioVideoMediaStream.getVideoTracks().forEach(function(b){b.enabled=false});this.remoteAudioVideoMediaStream.getAudioTracks().forEach(function(b){b.enabled=false});this.remoteAudioVideoMediaStream.getVideoTracks().forEach(function(b){b.enabled=false})}this.paused=!this.paused}catch(a){console.error(a)}};ABTOPhoneUA.prototype.transfer=function(i){console.debug("ABTOPhoneUA("+this.counter+"):transfer()");try{if(!(this.invitedState==this.INVITED_ACCEPTED_STATE||this.invitingState==this.INVITING_ACCEPTED_STATE)){console.debug("ABTOPhoneUA("+this.counter+"):transfer attempt when call not established");return}var c=this.sipUserName+"@"+this.sipDomain;var s=this.getInterlocutorsAddress();console.debug("ABTOPhoneUA("+this.counter+"):sendReferSipRequest(from:"+c+",to:"+s+", refer-to:"+i+")");var d=this.addressFactory.createSipURI_user_host(null,s);var g=this.listeningPoint.getViaHeader();var j=this.headerFactory.createMaxForwardsHeader(70);var r=this.addressFactory.createSipURI_user_host(null,c);var h=this.addressFactory.createAddress_name_uri(this.sipDisplayName,r);var m=this.headerFactory.createFromHeader(h,this.localTag);var n=this.addressFactory.createSipURI_user_host(null,s);var e=this.addressFactory.createAddress_name_uri(null,n);var t=this.headerFactory.createToHeader(e,null);var p;if(this.invitingState==this.INVITING_ACCEPTED_STATE){p=this.jainSipInvitingSentRequest.getCallId()}else{p=this.jainSipInvitedReceivedRequest.getCallId()}var l=this.headerFactory.createCSeqHeader(101,SIPRequest.prototype.REFER);var k=this.addressFactory.createSipURI_user_host(null,i);var q=this.addressFactory.createAddress_name_uri(null,k);var b=this.headerFactory.createReferToHeader(q,null);var a=this.headerFactory.createReferredByHeader(h);var o=this.headerFactory.createAuthorizationHeader(AuthenticationHeader.prototype.DIGEST);this.jainSipReferSentRequest=this.messageFactory.createRequest(d,SIPRequest.prototype.REFER,p,l,m,t,g,j);this.messageFactory.addHeader(this.jainSipReferSentRequest,b);this.messageFactory.addHeader(this.jainSipReferSentRequest,a);this.messageFactory.addHeader(this.jainSipReferSentRequest,o);this.messageFactory.addHeader(this.jainSipReferSentRequest,this.jainSipContactHeader);this.messageFactory.addHeader(this.jainSipReferSentRequest,this.jainSipUserAgentHeader);this.jainSipReferTransaction=this.sipProvider.getNewClientTransaction(this.jainSipReferSentRequest);this.jainSipReferSentRequest.setTransaction(this.jainSipReferTransaction);this.jainSipReferTransaction.sendRequest()}catch(f){console.error("ABTOPhoneUA("+this.counter+"):transfer(): caught exception:"+f);throw ("ABTOPhoneUA("+this.counter+"):transfer(): caught exception:"+f)}};ABTOPhoneUA.prototype.sendMessage=function(h,o){console.debug("ABTOPhoneUA("+this.counter+"):sendMessage()");try{var a=this.sipUserName+"@"+this.sipDomain;var k=h;if(!k){k=this.getInterlocutorsAddress()}var l=this.headerFactory.createCSeqHeader(0,"MESSAGE");var q=this.headerFactory.createCallIdHeader();var i=this.headerFactory.createMaxForwardsHeader(70);var d=this.addressFactory.createSipURI_user_host(null,k);var b=this.addressFactory.createSipURI_user_host(null,a);var g=this.addressFactory.createAddress_name_uri(this.sipDisplayName,b);var j=this.headerFactory.createFromHeader(g,new Date().getTime());var n=this.addressFactory.createSipURI_user_host(null,k);var c=this.addressFactory.createAddress_name_uri(null,n);var f=this.headerFactory.createToHeader(c,null);var m=this.listeningPoint.getViaHeader();var p=this.headerFactory.createContentTypeHeader("text","plain");this.lastMessageRequest=this.messageFactory.createRequest(d,"MESSAGE",q,l,j,f,m,i,p,o);this.messageFactory.addHeader(this.lastMessageRequest,this.jainSipUserAgentHeader);this.messageTransaction=this.sipProvider.getNewClientTransaction(this.lastMessageRequest);this.lastMessageRequest.setTransaction(this.messageTransaction);this.messageTransaction.sendRequest()}catch(e){console.debug("ABTOPhoneUA("+this.counter+"):sendMessage(): caught exception:"+e)}};ABTOPhoneUA.prototype.bye=function(){console.debug("ABTOPhoneUA("+this.counter+"):bye()");this.isConference=false;this.isUpgraded=false;this.conferenceId=null;this.conferenceMixerId=null;this.participantId=null;this.participantToken=null;if(this.invitingState==this.INVITING_ACCEPTED_STATE){try{var c=this.jainSipInvitingDialog.createRequest("BYE");c.addHeader(this.jainSipContactHeader);c.addHeader(this.jainSipUserAgentHeader);var a=this.sipProvider.getNewClientTransaction(c);this.jainSipInvitingDialog.sendRequest(a);this.invitingState=this.INVITING_LOCAL_HANGINGUP_STATE}catch(b){console.error("ABTOPhoneUA("+this.counter+"):bye(): caught exception:"+b);console.log("ABTOPhoneUA("+this.counter+"):bye(): caught exception:"+b);this.initPeerConnectionStateMachine();this.initSipInvitingStateMachine()}}else{if(this.invitedState==this.INVITED_ACCEPTED_STATE){try{var c=this.jainSipInvitedDialog.createRequest("BYE");c.addHeader(this.jainSipContactHeader);c.addHeader(this.jainSipUserAgentHeader);var a=this.sipProvider.getNewClientTransaction(c);c.setTransaction(a);this.jainSipInvitedDialog.sendRequest(a);this.invitedState=this.INVITED_LOCAL_HANGINGUP_STATE}catch(b){console.error("ABTOPhoneUA("+this.counter+"):bye(): caught exception:"+b);this.initPeerConnectionStateMachine();this.initSipInvitedStateMachine()}}else{if(this.invitingState==this.INVITING_STATE||this.invitingState==this.INVITING_407_STATE){try{this.jainSipCancelRequest=this.jainSipInvitingTransaction.createCancel();this.jainSipCancelRequest.addHeader(this.jainSipContactHeader);this.jainSipCancelRequest.addHeader(this.jainSipUserAgentHeader);this.jainSipCancelTransaction=this.sipProvider.getNewClientTransaction(this.jainSipCancelRequest);this.jainSipCancelTransaction.sendRequest();this.invitingState=this.INVITING_LOCAL_HANGINGUP_STATE}catch(b){console.error("ABTOPhoneUA("+this.counter+"):cancel(): caught exception:"+b);this.initPeerConnectionStateMachine();this.initSipInvitedStateMachine();this.initSipInvitingStateMachine()}}else{console.log("ABTOPhoneUA("+this.counter+"):bye(): bad state, action call unauthorized")}}}};ABTOPhoneUA.prototype.handleStateMachineInvitingResponseEvent=function(c){console.debug("ABTOPhoneUA("+this.counter+"):handleStateMachineInvitingResponseEvent(): this.invitingState="+this.invitingState);var k=c.getResponse();var d=parseInt(k.getStatusCode());if(this.invitingState==this.INVITING_STATE){if(d<200){if(this.inited&&this.onRinging){try{this.onRinging(1)}catch(f){console.error("ABTOPhoneUA("+this.counter+"):onRinging(): caught exception:"+f)}}console.debug("ABTOPhoneUA("+this.counter+"):handleStateMachineInvitingResponseEvent(): 1XX response ignored")}else{if(d==407||d==401){this.invitingState=this.INVITING_407_STATE;this.jainSipInvitingSentRequest=this.addAuthHeader(this.jainSipInvitingSentRequest,k);this.jainSipInvitingTransaction=this.sipProvider.getNewClientTransaction(this.jainSipInvitingSentRequest);this.jainSipInvitingSentRequest.setTransaction(this.jainSipInvitingTransaction);this.jainSipInvitingTransaction.sendRequest()}else{if(d==200){this.isConference=k.hasHeader("X-Conference-ID");if(!this.isConference){if(k.getHeader("X-Asterisk-Channel-LinkedId")!=null){this.linkedId=k.getHeader("X-Asterisk-Channel-LinkedId").value}if(k.getHeader("Call-Info")!=null){this.callInfo=k.getHeader("Call-Info").value}if(k.getHeader("X-Recovery-Session")!=null){this.recoverySession=k.getHeader("X-Recovery-Session").value}}else{this.conferenceId=k.getHeader("X-Conference-ID").value;if(k.hasHeader("X-Conference-Mixer-ID")){this.conferenceMixerId=parseInt(k.getHeader("X-Conference-Mixer-ID").value)}if(k.hasHeader("X-Participant-ID")){this.participantId=parseInt(k.getHeader("X-Participant-ID").value)}if(k.hasHeader("X-Participant-Token")){this.participantToken=k.getHeader("X-Participant-Token").value}}this.jainSipInvitingDialog=c.getOriginalTransaction().getDialog();this.invitingState=this.INVITING_ACCEPTED_STATE;this.jainSipInvitingDialog.setRemoteTarget(k.getHeader("Contact"));var g=c.getOriginalTransaction().createAck();this.jainSipInvitingDialog.sendAck(g);if(this.referredByUri!=null){this.sendNotifyReferDoneRequest(this.referredByUri,k);this.referredByUri=null}this.remoteTag=k.getToHeader().getTag();var i=k.getContent();var h=new RTCSessionDescription({type:"answer",sdp:i});var j=this;this.peerConnectionState="answer-received";if(i!=null){this.peerConnection.setRemoteDescription(h,function(){j.onPeerConnectionSetRemoteDescriptionSuccessCallback()},function(e){j.onPeerConnectionSetRemoteDescriptionErrorCallback(e)})}this.jainSipInvitingSentRespond=k}else{console.log("Call Rejected :"+k.getStatusLine().getReasonPhrase());if(this.inited&&this.onEstablishError){try{this.onEstablishError(1,d,k.getStatusLine().getReasonPhrase())}catch(f){console.error("ABTOPhoneUA("+this.counter+"):onEstablishError: caught exception:"+f)}}this.initPeerConnectionStateMachine();this.initSipInvitingStateMachine()}}}}else{if(this.invitingState==this.INVITING_407_STATE){if(d<200){console.debug("ABTOPhoneUA("+this.counter+"):handleStateMachineInvitingResponseEvent(): 1XX response ignored")}else{if(d==200){if(!this.isConference){this.linkedId=k.getHeader("X-Asterisk-Channel-LinkedId")!=null?k.getHeader("X-Asterisk-Channel-LinkedId").value:null;this.callInfo=k.getHeader("Call-Info")!=null?k.getHeader("Call-Info").value:null}else{this.conferenceId=k.getHeader("X-Conference-ID").value;if(k.hasHeader("X-Conference-Mixer-ID")){this.conferenceMixerId=parseInt(k.getHeader("X-Conference-Mixer-ID").value)}if(k.hasHeader("X-Participant-ID")){this.participantId=parseInt(k.getHeader("X-Participant-ID").value)}if(k.hasHeader("X-Participant-Token")){this.participantToken=k.getHeader("X-Participant-Token").value}}this.jainSipInvitingDialog=c.getOriginalTransaction().getDialog();this.invitingState=this.INVITING_ACCEPTED_STATE;this.jainSipInvitingDialog.setRemoteTarget(k.getHeader("Contact"));var g=c.getOriginalTransaction().createAck();this.jainSipInvitingDialog.sendAck(g);if(this.referredByUri!=null){this.sendNotifyReferDoneRequest(this.referredByUri,k);this.referredByUri=null}this.remoteTag=k.getToHeader().getTag();var i=k.getContent();var h=new RTCSessionDescription({type:"answer",sdp:i});var j=this;this.peerConnectionState="answer-received";this.peerConnection.setRemoteDescription(h,function(){j.onPeerConnectionSetRemoteDescriptionSuccessCallback()},function(e){j.onPeerConnectionSetRemoteDescriptionErrorCallback(e)});this.jainSipInvitingSentRespond=k}else{console.log("Call Failed:"+k.getStatusCode()+"  "+k.getStatusLine().getReasonPhrase());if(this.inited&&this.onEstablishError){try{this.onEstablishError(1,d,k.getStatusLine().getReasonPhrase())}catch(f){console.error("ABTOPhoneUA("+this.counter+"):onEstablishError: caught exception:"+f)}}this.initPeerConnectionStateMachine();this.initSipInvitingStateMachine()}}}else{if(this.invitingState==this.INVITING_FAILED_STATE){console.error("ABTOPhoneUA("+this.counter+"):handleStateMachineInvitingResponseEvent(): bad state, SIP response ignored")}else{if(this.invitingState==this.INVITING_ACCEPTED_STATE){if(d==407||d==401){this.holdAuthenticateRequest(k)}else{if(d==200){this.sendACK(c);this.toggleMediaStream();this.holdState=this.paused?this.HOLD_BY_ME:this.HOLD_OFF;this.fireOnHoldListener()}else{console.error("ABTOPhoneUA("+this.counter+"):handleStateMachineInvitingResponseEvent(): bad state, SIP response ignored")}}}else{if(this.invitingState==this.INVITING_LOCAL_HANGINGUP_STATE){if(d==401){var a=c.getOriginalTransaction().getMethod();if(a=="CANCEL"){var m=this.headerFactory.createAuthorizationHeader(k,this.jainSipCancelRequest,this.sipPassword,this.sipLogin);this.messageFactory.addHeader(this.jainSipCancelRequest,m);this.jainSipCancelRequest=this.setNewViaHeader(this.jainSipCancelRequest);this.jainSipCancelTransaction.currentState=null;this.jainSipCancelTransaction.sendRequest()}else{this.invitedState=this.INVITED_LOCAL_HANGINGUP_407_STATE;var b=this.jainSipInvitingDialog.createRequest("BYE",this.jainSipInvitingSentRespond);var l=this.sipProvider.getNewClientTransaction(b);var m=this.headerFactory.createAuthorizationHeader(k,b,this.sipPassword,this.sipLogin);this.messageFactory.addHeader(b,m);this.jainSipInvitingDialog.sendRequest(l);this.initPeerConnectionStateMachine();this.initSipInvitedStateMachine();this.initSipInvitingStateMachine()}}else{if(d==407){this.invitingState=this.INVITING_HANGINGUP_407_STATE;var b=this.jainSipInvitingDialog.createRequest("BYE");var l=this.sipProvider.getNewClientTransaction(b);var m=this.headerFactory.createAuthorizationHeader(k,b,this.sipPassword,this.sipLogin);this.messageFactory.addHeader(b,m);this.jainSipInvitingDialog.sendRequest(l)}else{if(d==200){if(this.remoteVideo!=null){this.remoteVideo.pause();this.remoteVideo.src=null}this.initPeerConnectionStateMachine();this.initSipInvitingStateMachine()}else{console.log("Call HangUp Failed:"+k.getStatusCode()+"  "+k.getStatusLine().getReasonPhrase());if(this.remoteVideo!=null){this.remoteVideo.pause();this.remoteVideo.src=null}this.initPeerConnectionStateMachine();this.initSipInvitingStateMachine()}}}}else{if(this.invitingState==this.INVITING_LOCAL_HANGINGUP_407_STATE){console.error("ABTOPhoneUA("+this.counter+"):handleStateMachineInvitingResponseEvent(): bad state, SIP response ignored")}}}}}}};ABTOPhoneUA.prototype.handleStateMachineInvitingRequestEvent=function(a){console.debug("ABTOPhoneUA("+this.counter+"):handleStateMachineInvitingRequestEvent(): this.invitingState="+this.invitingState);var b=a.getRequest();var d=b.getMethod();if(this.invitingState==this.INVITING_STATE){if(d=="CANCEL"){var f=b.createResponse(200,"OK");f.addHeader(this.jainSipContactHeader);a.getServerTransaction().sendResponse(f);if(this.inited&&this.onHangUp){try{this.onHangUp(1)}catch(c){console.error("ABTOPhoneUA("+this.counter+"):onHangUp(): caught exception:"+c)}}this.initPeerConnectionStateMachine();this.initSipInvitingStateMachine()}else{console.error("ABTOPhoneUA("+this.counter+"):handleStateMachineInvitingRequestEvent(): bad state, SIP request ignored")}console.error("ABTOPhoneUA("+this.counter+"):handleStateMachineInvitingRequestEvent(): bad state, SIP request ignored")}else{if(this.invitingState==this.INVITING_407_STATE){console.error("ABTOPhoneUA("+this.counter+"):handleStateMachineInvitingRequestEvent(): bad state, SIP request ignored")}else{if(this.invitingState==this.INVITING_FAILED_STATE){console.error("ABTOPhoneUA("+this.counter+"):handleStateMachineInvitingRequestEvent(): bad state, SIP request ignored")}else{if(this.invitingState==this.INVITING_ACCEPTED_STATE){if(d=="BYE"){var f=b.createResponse(200,"OK");f.addHeader(this.jainSipContactHeader);f.addHeader(this.jainSipUserAgentHeader);a.getServerTransaction().sendResponse(f);if(this.inited&&this.onHangUp){try{this.onHangUp(1)}catch(c){console.error("ABTOPhoneUA("+this.counter+"):onHangUp(): caught exception:"+c)}}this.initPeerConnectionStateMachine();this.initSipInvitingStateMachine();this.inviteReferToAddress()}else{console.error("ABTOPhoneUA("+this.counter+"):handleStateMachineInvitingRequestEvent(): bad state, SIP request ignored")}}else{if(this.invitingState==this.INVITING_LOCAL_HANGINGUP_STATE){if(d=="BYE"){var f=b.createResponse(200,"OK");f.addHeader(this.jainSipContactHeader);a.getServerTransaction().sendResponse(f);this.initPeerConnectionStateMachine();this.initSipInvitedStateMachine();this.initSipInvitingStateMachine();console.error("ABTOPhoneUA("+this.counter+"):handleStateMachineInvitingRequestEvent(): bad state, already hanging up 200 Ok anyway")}else{console.error("ABTOPhoneUA("+this.counter+"):handleStateMachineInvitingRequestEvent(): bad state, SIP request ignored")}}else{if(this.invitingState==this.INVITING_LOCAL_HANGINGUP_407_STATE){console.error("ABTOPhoneUA("+this.counter+"):handleStateMachineInvitingRequestEvent(): bad state, SIP request ignored")}}}}}}};ABTOPhoneUA.prototype.handleStateMachineInvitedResponseEvent=function(e){console.debug("ABTOPhoneUA("+this.counter+"):handleStateMachineInvitedResponseEvent(): this.invitingState="+this.invitingState);var f=e.getResponse();var d=parseInt(f.getStatusCode());if(this.invitedState==this.INVITED_RINGING_STATE){console.error("ABTOPhoneUA("+this.counter+"):handleStateMachineInvitedResponseEvent(): bad state, SIP response ignored")}else{if(this.invitedState==this.INVITED_ACCEPTED_STATE){if(d==407||d==401){this.holdAuthenticateRequest(f)}else{if(d==200){this.sendACK(e);this.toggleMediaStream();this.holdState=this.paused?this.HOLD_BY_ME:this.HOLD_OFF;this.fireOnHoldListener()}else{console.error("ABTOPhoneUA("+this.counter+"):handleStateMachineInvitedResponseEvent(): bad state, SIP response ignored")}}}else{if(this.invitedState==this.INVITED_LOCAL_HANGINGUP_STATE){if(d==407||d==401){this.invitedState=this.INVITED_LOCAL_HANGINGUP_407_STATE;var c=this.jainSipInvitedDialog.createRequest("BYE");var a=this.sipProvider.getNewClientTransaction(c);var b=this.headerFactory.createAuthorizationHeader(f,c,this.sipPassword,this.sipLogin);this.messageFactory.addHeader(c,b);this.jainSipInvitedDialog.sendRequest(a);this.initPeerConnectionStateMachine();this.initSipInvitedStateMachine();this.initSipInvitingStateMachine()}else{if(d==200){this.initPeerConnectionStateMachine();this.initSipInvitedStateMachine();this.initSipInvitingStateMachine()}else{console.log("Call HangUp Failed:"+f.getStatusCode()+"  "+f.getStatusLine().getReasonPhrase());this.initPeerConnectionStateMachine();this.initSipInvitedStateMachine()}}}else{if(this.invitedState==this.INVITED_LOCAL_HANGINGUP_407_STATE){if(d==200){this.initPeerConnectionStateMachine();this.initSipInvitedStateMachine()}else{console.log("Call HangUp Failed:"+f.getStatusCode()+"  "+f.getStatusLine().getReasonPhrase());this.initPeerConnectionStateMachine();this.initSipInvitedStateMachine()}}}}}};ABTOPhoneUA.prototype.handleStateMachineInvitedRequestEvent=function(b){console.debug("ABTOPhoneUA("+this.counter+"):handleStateMachineInvitedRequestEvent(): this.invitedState="+this.invitedState);var d=b.getRequest();var g=d.getMethod();var c=d.getHeader("From");if(this.invitedState==this.INVITED_INITIAL_STATE){if(g=="INVITE"){this.isConference=d.hasHeader("X-Conference-ID");this.isUpgraded=false;this.conferenceId=null;this.conferenceMixerId=null;this.participantId=null;this.participantToken=null;console.log("Handling INVITE isConference = "+this.isConference+" "+this.conferenceId);this.remoteUser=c.getAddress().getURI();this.remoteTag=c.getTag();if(!this.isConference){this.linkedId=d.getHeader("X-Asterisk-Channel-LinkedId")!=null?d.getHeader("X-Asterisk-Channel-LinkedId").value:null}else{this.conferenceId=d.getHeader("X-Conference-ID").value;if(d.hasHeader("X-Conference-Mixer-ID")){this.conferenceMixerId=parseInt(d.getHeader("X-Conference-Mixer-ID").value)}if(d.hasHeader("X-Participant-ID")){this.participantId=parseInt(d.getHeader("X-Participant-ID").value)}if(d.hasHeader("X-Participant-Token")){this.participantToken=d.getHeader("X-Participant-Token").value}}if(this.inited&&this.onNewCall){try{this.onNewCall(1)}catch(f){console.error("ABTOPhoneUA("+this.counter+"):onNewCall(): caught exception:"+f)}}this.invitedState=this.INVITED_RINGING_STATE;var a=d.createResponse(180,"Ringing");a.addHeader(this.jainSipContactHeader);a.addHeader(this.jainSipUserAgentHeader);b.getServerTransaction().sendResponse(a);this.jainSipInvitedReceivedRequest=d;this.jainSipInvitedTransaction=b.getServerTransaction();this.jainSipInvitedDialog=b.getServerTransaction().getDialog();console.debug("ABTOPhoneUA("+this.counter+"):handleStateMachineInvitedRequestEvent(): sipUri.getUser()="+this.remoteUser.getUser());if(this.inited&&this.onInvited){try{this.onInvited(1,this.remoteUser.toString())}catch(f){console.error("ABTOPhoneUA("+this.counter+"):onInvited(): caught exception:"+f)}}}else{if(g=="CANCEL"){var i=d.createResponse(200,"OK");i.addHeader(this.jainSipContactHeader);i.addHeader(this.jainSipUserAgentHeader);b.getServerTransaction().sendResponse(i);var h=this.jainSipInvitedReceivedRequest.createResponse(487,"(Request Cancelled)");i.addHeader(this.jainSipContactHeader);h.addHeader(this.jainSipUserAgentHeader);this.jainSipInvitedTransaction.sendMessage(h);this.invitedState=this.INVITED_INITIAL_STATE;this.jainSipInvitedReceivedRequest=null;this.jainSipInvitedDialog=null;if(this.inited&&this.onHangUp){try{this.onHangUp(1)}catch(f){console.error("ABTOPhoneUA("+this.counter+"):onHangUp(): caught exception:"+f)}}this.initPeerConnectionStateMachine();this.initSipInvitingStateMachine()}}}else{if(this.invitedState==this.INVITED_RINGING_STATE){if(g=="CANCEL"){var i=d.createResponse(200,"OK");i.addHeader(this.jainSipContactHeader);i.addHeader(this.jainSipUserAgentHeader);b.getServerTransaction().sendResponse(i);var h=this.jainSipInvitedReceivedRequest.createResponse(487,"(Request Cancelled)");i.addHeader(this.jainSipContactHeader);h.addHeader(this.jainSipUserAgentHeader);this.jainSipInvitedTransaction.sendMessage(h);this.invitedState=this.INVITED_INITIAL_STATE;this.jainSipInvitedReceivedRequest=null;this.jainSipInvitedDialog=null;if(this.inited&&this.onHangUp){try{this.onHangUp(1)}catch(f){console.error("ABTOPhoneUA("+this.counter+"):onHangUp(): caught exception:"+f)}}this.initPeerConnectionStateMachine();this.initSipInvitingStateMachine()}else{console.error("ABTOPhoneUA("+this.counter+"):handleStateMachineInvitedRequestEvent(): bad state, SIP request ignored")}}else{if(this.invitedState==this.INVITED_ACCEPTED_STATE){if(g=="BYE"){var i=d.createResponse(200,"OK");i.addHeader(this.jainSipContactHeader);i.addHeader(this.jainSipUserAgentHeader);b.getServerTransaction().sendResponse(i);this.invitedState=this.INVITED_INITIAL_STATE;this.jainSipInvitedReceivedRequest=null;this.jainSipInvitedDialog=null;if(this.remoteVideo!=null){this.remoteVideo.pause();this.remoteVideo.src=null}if(this.inited&&this.onHangUp){try{this.onHangUp(1)}catch(f){console.error("ABTOPhoneUA("+this.counter+"):onHangUp(): caught exception:"+f)}}this.initPeerConnectionStateMachine();this.initSipInvitingStateMachine();this.inviteReferToAddress()}else{if(g=="ACK"){this.jainSipInvitedDialog=b.getServerTransaction().getDialog();if(!this.isConference&&d.getHeader("X-Recovery-Session")!=null){this.recoverySession=d.getHeader("X-Recovery-Session").value}}else{console.error("ABTOPhoneUA("+this.counter+"):handleStateMachineInvitedRequestEvent(): bad state, SIP request ignored")}}}else{if(this.invitedState==this.INVITED_LOCAL_HANGINGUP_STATE){if(g=="BYE"){var i=d.createResponse(200,"OK");i.addHeader(this.jainSipContactHeader);b.getServerTransaction().sendResponse(i);this.initPeerConnectionStateMachine();this.initSipInvitedStateMachine();this.initSipInvitingStateMachine();console.error("ABTOPhoneUA("+this.counter+"):handleStateMachineInvitingRequestEvent(): bad state, already hanging up 200 Ok anyway")}else{console.error("ABTOPhoneUA("+this.counter+"):handleStateMachineInvitingRequestEvent(): bad state, SIP request ignored")}}else{if(this.invitedState==this.INVITED_LOCAL_HANGINGUP_407_STATE){console.error("ABTOPhoneUA("+this.counter+"):handleStateMachineInvitedRequestEvent(): bad state, SIP request ignored")}}}}}};ABTOPhoneUA.prototype.handleStateMachineUpdateRequestEvent=function(a){console.debug("ABTOPhoneUA("+this.counter+"):handleStateMachineUpdateRequestEvent(): this.invitedState="+this.invitedState);var e=a.getRequest();if(this.invitedState==this.INVITED_ACCEPTED_STATE||this.invitingState==this.INVITING_ACCEPTED_STATE){this.jainSipInvitedReceivedRequest=e;this.jainSipInvitedTransaction=a.getServerTransaction();this.jainSipInvitedDialog=a.getServerTransaction().getDialog();try{this.lastReceivedSdpOfferString=this.jainSipInvitedReceivedRequest.getContent();var f=new RTCSessionDescription({type:"offer",sdp:this.lastReceivedSdpOfferString});var b=this;this.peerConnectionState="update-received";this.createPeerConnectionWithoutStunServer();this.peerConnection.addStream(this.localAudioVideoMediaStream,null);this.peerConnection.setRemoteDescription(f,function(){b.onPeerConnectionSetRemoteDescriptionSuccessCallback()},function(g){b.onPeerConnectionSetRemoteDescriptionErrorCallback(g)})}catch(c){var d=this.jainSipInvitedReceivedRequest.createResponse(480,"Temporarily Unavailable");d.addHeader(this.jainSipContactHeader);d.addHeader(this.jainSipUserAgentHeader);this.jainSipInvitedTransaction.sendResponse(d);this.initPeerConnectionStateMachine();this.initSipInvitedStateMachine();console.error("ABTOPhoneUA("+this.counter+"):handleStateMachineUpdateRequestEvent(): caught exception:"+c);return false}}else{var d=this.jainSipInvitedReceivedRequest.createResponse(480,"Temporarily Unavailable");d.addHeader(this.jainSipContactHeader);d.addHeader(this.jainSipUserAgentHeader);this.jainSipInvitedTransaction.sendResponse(d);this.initPeerConnectionStateMachine();this.initSipInvitedStateMachine();console.error("ABTOPhoneUA("+this.counter+"):handleStateMachineUpdateRequestEvent(): Update received while not in inited state");return false}};ABTOPhoneUA.prototype.createPeerConnection=function(){console.debug("ABTOPhoneUA("+this.counter+"):createPeerConnection()");var c=this;var b;if(useStun){b={iceServers:this.iceServers,rtcpMuxPolicy:"negotiate"}}else{b={iceServers:[],rtcpMuxPolicy:"negotiate"}}var a={optional:[{DtlsSrtpKeyAgreement:true}]};if(this.isConference){console.debug("ABTOPhoneUA.createPeerConnection(): conference call, no STUN");b={iceServers:[],rtcpMuxPolicy:"negotiate"}}if(this.peerConnection){try{this.peerConnection.close()}catch(d){}}this.peerConnection=new RTCPeerConnection(b,a);this.peerConnection.onaddstream=function(e){c.onPeerConnectionOnAddStreamCallback(e)};this.peerConnection.onremovestream=function(e){c.onPeerConnectionOnRemoveStreamCallback(e)};this.peerConnection.onstatechange=function(e){c.onPeerConnectionStateChangeCallback(e)};this.peerConnection.onicecandidate=function(e){c.onPeerConnectionIceCandidateCallback(e)};this.peerConnection.ongatheringchange=function(e){c.onPeerConnectionGatheringChangeCallback(e)};this.peerConnection.onicechange=function(e){c.onPeerConnectionIceChangeCallback(e)};this.peerConnection.onopen=function(e){c.onPeerConnectionOnOpenCallback(e)}};ABTOPhoneUA.prototype.createPeerConnectionWithoutStunServer=function(){console.debug("ABTOPhoneUA("+this.counter+"):createPeerConnection()");var a=this;if(this.peerConnection){try{this.peerConnection.close()}catch(b){}}this.peerConnection=new RTCPeerConnection(null,null);this.peerConnection.onaddstream=function(c){a.onPeerConnectionOnAddStreamCallback(c)};this.peerConnection.onremovestream=function(c){a.onPeerConnectionOnRemoveStreamCallback(c)};this.peerConnection.onstatechange=function(c){a.onPeerConnectionStateChangeCallback(c)};this.peerConnection.onicecandidate=function(c){a.onPeerConnectionIceCandidateCallback(c)};this.peerConnection.ongatheringchange=function(c){a.onPeerConnectionGatheringChangeCallback(c)};this.peerConnection.onicechange=function(c){a.onPeerConnectionIceChangeCallback(c)};this.peerConnection.onopen=function(c){a.onPeerConnectionOnOpenCallback(c)}};ABTOPhoneUA.prototype.onPeerConnectionOnAddStreamCallback=function(a){console.debug("ABTOPhoneUA("+this.counter+"):onPeerConnectionOnAddStreamCallback(): event="+a);if(this.peerConnection!=null){var c=a.stream;this.remoteAudioVideoMediaStream=c;if(this.remoteVideo!=null){this.remoteVideo.srcObject=c;this.remoteVideo.play()}if(this.inited&&this.onRemoteVideoStarted){try{this.onRemoteVideoStarted(c)}catch(b){console.error("ABTOPhoneUA("+this.counter+"):onRemoteVideoStarted(): caught exception:"+b)}}}else{console.error("SimpleWebRtcSipPhone:onPeerConnectionOnAddStreamCallback(): this.peerConnection is null, bug in state machine!, bug in state machine!")}};ABTOPhoneUA.prototype.onPeerConnectionOnRemoveStreamCallback=function(a){console.debug("ABTOPhoneUA("+this.counter+"):onPeerConnectionOnRemoveStreamCallback(): event="+a);if(this.peerConnection!=null){this.remoteAudioVideoMediaStream=null;if(this.remoteVideo!=null){this.remoteVideo.pause();this.remoteVideo.src=null}if(this.inited&&this.onRemoteVideoStopped){try{this.onRemoteVideoStopped()}catch(b){console.error("ABTOPhoneUA("+this.counter+"):onRemoteVideoStopped(): caught exception:"+b)}}}else{console.warn("SimpleWebRtcSipPhone:onPeerConnectionOnRemoveStreamCallback(): this.peerConnection is null, bug in state machine!")}};ABTOPhoneUA.prototype.onPeerConnectionOnOpenCallback=function(a){console.debug("ABTOPhoneUA("+this.counter+"):onPeerConnectionOnOpenCallback(): event="+a)};ABTOPhoneUA.prototype.onPeerConnectionStateChangeCallback=function(a){console.debug("ABTOPhoneUA("+this.counter+"):onPeerConnectionStateChangeCallback(): event="+a)};ABTOPhoneUA.prototype.onPeerConnectionIceCandidateCallback=function(c){console.debug("ABTOPhoneUA("+this.counter+"):onPeerConnectionIceCandidateCallback(): rtcIceCandidateEvent="+c);console.debug("ABTOPhoneUA("+this.counter+"):onPeerConnectionIceCandidateCallback(): rtcIceCandidateEvent.candidate="+c.candidate);if(this.peerConnection!=null){console.debug("ABTOPhoneUA("+this.counter+"):onPeerConnectionIceCandidateCallback(): this.peerConnection.readyState="+this.peerConnection.readyState);console.debug("ABTOPhoneUA("+this.counter+"):onPeerConnectionIceCandidateCallback(): this.peerConnection.iceGatheringState="+this.peerConnection.iceGatheringState);console.debug("ABTOPhoneUA("+this.counter+"):onPeerConnectionIceCandidateCallback(): this.peerConnection.iceState="+this.peerConnection.iceState);console.debug("ABTOPhoneUA("+this.counter+"):onPeerConnectionIceCandidateCallback: this.peerConnectionState="+this.peerConnectionState);if(c.candidate!=null){console.debug("ABTOPhoneUA("+this.counter+"):onPeerConnectionIceCandidateCallback: RTCIceCandidateEvent.candidate.candidate="+c.candidate.candidate);try{window.clearTimeout(this.timer)}catch(b){}this.timer=window.setTimeout(function(d){console.debug("ABTOPhoneUA("+this.counter+"):onPeerConnectionIceTimeout fired, ending ICE gathering");d.onPeerConnectionIceCandidateCallback({candidate:null})},10000,this)}else{console.debug("ABTOPhoneUA("+this.counter+"):onPeerConnectionIceCandidateCallback: no anymore ICE candidate");try{window.clearTimeout(this.timer)}catch(b){}if(this.peerConnectionState=="preparing-offer"){var a=this.peerConnection.localDescription.sdp;if(this.maxVideoBandwidth){a=a.replace(/(m=video.*\r\nc=IN.*\r\n)/m,"$1b=AS:"+this.maxVideoBandwidth+"\r\n")}this.sendInviteSipRequest(a);this.peerConnectionState="offer-sent";if(this.inited&&this.onNewCall){try{this.onNewCall(1)}catch(b){console.error("ABTOPhoneUA("+this.counter+"):onNewCall(): caught exception:"+b)}}}else{if(this.peerConnectionState=="preparing-answer"||this.peerConnectionState=="preparing-update"){var a=this.peerConnection.localDescription.sdp;if(this.maxVideoBandwidth){a=a.replace(/(m=video.*\r\nc=IN.*\r\n)/m,"$1b=AS:"+this.maxVideoBandwidth+"\r\n")}this.send200OKSipResponse(a);this.peerConnectionState="established"}else{if(this.peerConnectionState=="established"){}else{console.log("ABTOPhoneUA("+this.counter+"):onPeerConnectionIceCandidateCallback(): RTCPeerConnection bad state!")}}}}}else{console.warn("SimpleWebRtcSipPhone:onPeerConnectionIceCandidateCallback(): this.peerConnection is null, bug in state machine!")}};ABTOPhoneUA.prototype.onPeerConnectionCreateOfferSuccessCallback=function(b){console.debug("ABTOPhoneUA("+this.counter+"):onPeerConnectionCreateOfferSuccessCallback(): newOffer="+b);if(this.peerConnection!=null){if(this.peerConnectionState=="new"){var a=this;this.peerConnectionState="preparing-offer";this.peerConnection.setLocalDescription(b,function(){a.onPeerConnectionSetLocalDescriptionSuccessCallback()},function(c){a.onPeerConnectionSetLocalDescriptionErrorCallback(c)})}else{console.error("ABTOPhoneUA("+this.counter+"):onPeerConnectionCreateOfferSuccessCallback(): RTCPeerConnection bad state!")}}else{console.warn("SimpleWebRtcSipPhone:onPeerConnectionCreateOfferSuccessCallback(): this.peerConnection is null, bug in state machine!")}};ABTOPhoneUA.prototype.onPeerConnectionCreateOfferErrorCallback=function(a){console.debug("ABTOPhoneUA("+this.counter+"):onPeerConnectionCreateOfferErrorCallback():error="+a)};ABTOPhoneUA.prototype.onPeerConnectionSetLocalDescriptionSuccessCallback=function(){console.debug("ABTOPhoneUA("+this.counter+"):onPeerConnectionSetLocalDescriptionSuccessCallback()")};ABTOPhoneUA.prototype.onPeerConnectionSetLocalDescriptionErrorCallback=function(a){console.debug("ABTOPhoneUA("+this.counter+"):onPeerConnectionSetLocalDescriptionErrorCallback():error="+a);if(this.peerConnectionState=="preparing-update"){try{this.peerConnectionState="failed";var c=this.jainSipInvitedReceivedRequest.createResponse(480,a);c.addHeader(this.jainSipContactHeader);c.addHeader(this.jainSipUserAgentHeader);this.jainSipInvitedTransaction.sendResponse(c)}catch(b){console.error("ABTOPhoneUA("+this.counter+"):send200OKSipResponse(): caught exception:"+b);throw ("ABTOPhoneUA("+this.counter+"):send200OKSipResponse(): caught exception:"+b)}}else{console.log("onPeerConnectionSetLocalDescriptionErrorCallback error:"+a)}};ABTOPhoneUA.prototype.onPeerConnectionCreateAnswerSuccessCallback=function(b){console.debug("ABTOPhoneUA("+this.counter+"):onPeerConnectionCreateAnswerSuccessCallback():answer="+b);if(this.peerConnection!=null){if(this.peerConnectionState=="offer-received"){var a=this;this.peerConnectionState="preparing-answer";this.peerConnection.setLocalDescription(b,function(){a.onPeerConnectionSetLocalDescriptionSuccessCallback()},function(c){a.onPeerConnectionSetLocalDescriptionErrorCallback(c)})}else{if(this.peerConnectionState=="update-received"){var a=this;this.peerConnectionState="preparing-update";this.peerConnection.setLocalDescription(b,function(){a.onPeerConnectionSetLocalDescriptionSuccessCallback()},function(c){a.onPeerConnectionSetLocalDescriptionErrorCallback(c)})}else{console.log("ABTOPhoneUA("+this.counter+"):onPeerConnectionCreateAnswerSuccessCallback(): RTCPeerConnection bad state!")}}}else{console.warn("SimpleWebRtcSipPhone:onPeerConnectionCreateAnswerSuccessCallback(): this.peerConnection is null, bug in state machine!")}};ABTOPhoneUA.prototype.onPeerConnectionCreateAnswerErrorCallback=function(a){console.debug("ABTOPhoneUA("+this.counter+"):onPeerConnectionCreateAnswerErrorCallback():error="+a)};ABTOPhoneUA.prototype.onPeerConnectionSetRemoteDescriptionSuccessCallback=function(){console.debug("ABTOPhoneUA("+this.counter+"):onPeerConnectionSetRemoteDescriptionSuccessCallback()");if(this.peerConnection!=null){console.debug("ABTOPhoneUA("+this.counter+"):onPeerConnectionSetRemoteDescriptionSuccessCallback(): this.peerConnection.readyState="+this.peerConnection.readyState);console.debug("ABTOPhoneUA("+this.counter+"):onPeerConnectionSetRemoteDescriptionSuccessCallback(): this.peerConnection.iceGatheringState="+this.peerConnection.iceGatheringState);console.debug("ABTOPhoneUA("+this.counter+"):onPeerConnectionSetRemoteDescriptionSuccessCallback(): this.peerConnection.iceState="+this.peerConnection.iceState);console.debug("ABTOPhoneUA("+this.counter+"):onPeerConnectionSetRemoteDescriptionSuccessCallback: this.peerConnectionState="+this.peerConnectionState);if(this.peerConnectionState=="answer-received"){this.peerConnectionState="established";if(this.inited){if(this.checkConnection(twoByteHigh)&&this.onEstablished){try{this.onEstablished(1,this.remoteUser.toString())}catch(b){console.error("ABTOPhoneUA("+this.counter+"):onEstablished(): caught exception:"+b)}}}}else{if(this.peerConnectionState=="offer-received"||this.peerConnectionState=="update-received"){var a=this;this.peerConnection.createAnswer(function(c){a.onPeerConnectionCreateAnswerSuccessCallback(c)},function(c){a.onPeerConnectionCreateAnswerErrorCallback(c)})}else{console.log("ABTOPhoneUA("+this.counter+"):onPeerConnectionSetRemoteDescriptionSuccessCallback(): RTCPeerConnection bad state!")}}}else{console.warn("SimpleWebRtcSipPhone:onPeerConnectionSetRemoteDescriptionSuccessCallback(): this.peerConnection is null, bug in state machine!")}};ABTOPhoneUA.prototype.onPeerConnectionSetRemoteDescriptionErrorCallback=function(a){console.debug("ABTOPhoneUA("+this.counter+"):onPeerConnectionSetRemoteDescriptionErrorCallback():error="+a);if(this.peerConnection!=null){console.debug("ABTOPhoneUA("+this.counter+"):onPeerConnectionSetRemoteDescriptionErrorCallback(): this.peerConnection.readyState="+this.peerConnection.readyState);console.debug("ABTOPhoneUA("+this.counter+"):onPeerConnectionSetRemoteDescriptionErrorCallback(): this.peerConnection.iceGatheringState="+this.peerConnection.iceGatheringState);console.debug("ABTOPhoneUA("+this.counter+"):onPeerConnectionSetRemoteDescriptionErrorCallback(): this.peerConnection.iceState="+this.peerConnection.iceState);console.debug("ABTOPhoneUA("+this.counter+"):onPeerConnectionSetRemoteDescriptionErrorCallback: this.peerConnectionState="+this.peerConnectionState);if(this.peerConnectionState=="answer-received"){if(this.inited&&this.onEstablishError){try{this.onEstablishError(1,500,a)}catch(b){console.error("ABTOPhoneUA("+this.counter+"):onEstablishError(): caught exception:"+b)}}this.bye()}else{if(this.peerConnectionState=="offer-received"||this.peerConnectionState=="update-received"){this.error()}}}else{console.warn("SimpleWebRtcSipPhone:onPeerConnectionSetRemoteDescriptionErrorCallback(): this.peerConnection is null, bug in state machine!")}console.log("onPeerConnectionSetRemoteDescriptionErrorCallback error:"+a)};ABTOPhoneUA.prototype.onPeerConnectionIceNegotationNeededCallback=function(a){console.debug("ABTOPhoneUA("+this.counter+"):onPeerConnectionIceNegotationNeededCallback():event="+a)};ABTOPhoneUA.prototype.onPeerConnectionGatheringChangeCallback=function(a){console.debug("ABTOPhoneUA("+this.counter+"):onPeerConnectionGatheringChangeCallback():event="+a)};ABTOPhoneUA.prototype.onPeerConnectionIceChangeCallback=function(a){console.debug("ABTOPhoneUA("+this.counter+"):onPeerConnectionIceChangeCallback():event="+a)};ABTOPhoneUA.prototype.onPeerConnectionIdentityResultCallback=function(a){console.debug("ABTOPhoneUA("+this.counter+"):onPeerConnectionIdentityResultCallback():event="+a)};ABTOPhoneUA.prototype.checkConnection=function(c){if(c<16777215){var a=this;var b=setTimeout(function(){a.processTimeout(c,b);clearTimeout(b);b=null},c)}return c};ABTOPhoneUA.prototype.accept=function(){try{this.createPeerConnection();this.peerConnection.addStream(this.localAudioVideoMediaStream,null);this.lastReceivedSdpOfferString=this.jainSipInvitedReceivedRequest.getContent();if(this.maxVideoBandwidth&&this.lastReceivedSdpOfferString.indexOf("b=AS:")==-1){this.lastReceivedSdpOfferString=this.lastReceivedSdpOfferString.replace(/(m=video.*\r\nc=IN.*\r\n)/m,"$1b=AS:"+this.maxVideoBandwidth+"\r\n")}var d=new RTCSessionDescription({type:"offer",sdp:this.lastReceivedSdpOfferString});var a=this;this.peerConnectionState="offer-received";this.peerConnection.setRemoteDescription(d,function(){a.onPeerConnectionSetRemoteDescriptionSuccessCallback()},function(e){a.onPeerConnectionSetRemoteDescriptionErrorCallback(e)})}catch(b){var c=this.jainSipInvitedReceivedRequest.createResponse(480,"Temporarily Unavailable");c.addHeader(this.jainSipContactHeader);c.addHeader(this.jainSipUserAgentHeader);this.jainSipInvitedTransaction.sendResponse(c);this.initPeerConnectionStateMachine();this.initSipInvitedStateMachine();console.error("ABTOPhoneUA("+this.counter+"):handleStateMachineInvitedRequestEvent(): caught exception:"+b);return false}return true};ABTOPhoneUA.prototype.reject=function(){var a=this.jainSipInvitedReceivedRequest.createResponse(486,"Busy Here");a.addHeader(this.jainSipUserAgentHeader);this.jainSipInvitedTransaction.sendResponse(a);this.initPeerConnectionStateMachine();this.initSipInvitedStateMachine()};ABTOPhoneUA.prototype.error=function(){var a=this.jainSipInvitedReceivedRequest.createResponse(500,"Error");a.addHeader(this.jainSipContactHeader);a.addHeader(this.jainSipUserAgentHeader);this.jainSipInvitedTransaction.sendResponse(a);this.initPeerConnectionStateMachine();this.initSipInvitedStateMachine()};